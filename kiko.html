<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta http-equiv="Permissions-Policy" content="microphone=*, camera=*">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, OPTIONS">
  <meta http-equiv="Access-Control-Allow-Headers" content="Content-Type, Authorization">
  <title>KiKo - Intelligent Chat Assistant</title>
  <style>
    :root {
      --bg-primary: #1e1e1e;
      --text-primary: #ffffff;
      --accent-color: #bb86fc;
      --secondary-color: #03dac6;
      --panel-bg: #2c2c2c;
      --border-radius: 10px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .app-container {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
      gap: 10px;
      padding: 10px;
    }
    .chat-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      position: relative;
      overflow: hidden;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: rgba(255,255,255,0.05);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .message {
      max-width: 80%;
      margin: 6px 0;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .user-message {
      background-color: var(--accent-color);
      align-self: flex-end;
      margin-left: auto;
      color: #000;
    }
    .ai-message {
      background-color: rgba(255,255,255,0.1);
      align-self: flex-start;
    }
    .error-message {
      color: #ff4b4b;
      background-color: rgba(255,0,0,0.2);
    }
    .thinking-message {
      font-style: italic;
      opacity: 0.8;
    }
    #input-container {
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex-grow: 1;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      border-radius: 5px;
    }
    #send-btn, #voice-btn {
      background-color: var(--secondary-color);
      color: var(--bg-primary);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    #voice-btn.active {
      background-color: red;
      color: white;
    }
    #listening-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: red;
      animation: pulse 1.5s infinite;
      position: absolute;
      top: 15px;
      right: 15px;
      display: none;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    .media-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .media-container {
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .media-container h4 {
      margin-bottom: 10px;
    }
    #camera-area, #video-area {
      flex: 1;
      display: none;
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
      background-color: #000;
    }
    #camera-area.active {
      display: flex;
    }
    #video-area.active {
      display: flex;
    }
    #camera-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #camera-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    #video-area iframe {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: var(--border-radius);
      border: none;
      allow: autoplay;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è Android TV */
    @media (hover: none) {
      #send-btn, #voice-btn {
        padding: 15px 30px;
        font-size: 1.2em;
        transition: none;
      }
      #send-btn:focus, #voice-btn:focus {
        outline: 3px solid var(--accent-color);
        transform: scale(1.1);
      }
      #user-input:focus {
        outline: 3px solid var(--accent-color);
      }
    }
  </style>
  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ HTTPS (–µ—Å–ª–∏ –Ω–µ localhost, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º)
    if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost')) {
      window.location.href = window.location.href.replace('http:', 'https:');
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Android TV
    const isAndroidTV = navigator.userAgent.toLowerCase().includes('android tv') ||
                        navigator.userAgent.toLowerCase().includes('smart tv');
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Android TV
    function initForTV() {
      document.documentElement.style.fontSize = '24px';
      const style = document.createElement('style');
      style.textContent = `
        button:hover { 
          transform: none !important;
          opacity: 1 !important;
        }
        #send-btn, #voice-btn {
          padding: 15px 30px;
          font-size: 1.2em;
        }
        #user-input {
          font-size: 1.2em;
          padding: 15px;
        }
      `;
      document.head.appendChild(style);
      document.querySelectorAll('button').forEach(btn => {
        btn.setAttribute('tabindex', '0');
      });
      userInput.setAttribute('tabindex', '0');
    }
  </script>
</head>
<body>
  <div class="app-container">
    <!-- –ß–∞—Ç -->
    <div class="chat-panel">
      <div id="listening-indicator"></div>
      <div id="chat-container"></div>
      <div id="input-container">
        <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
        <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="voice-btn">üé§</button>
      </div>
    </div>
    <!-- –ö–∞–º–µ—Ä–∞ –∏ YouTube -->
    <div class="media-panel">
      <div class="media-container">
        <h4>–ö–∞–º–µ—Ä–∞</h4>
        <div id="camera-area">
          <video id="camera-preview" autoplay muted></video>
          <button id="camera-btn">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
      </div>
      <div class="media-container">
        <h4>YouTube</h4>
        <div id="video-area">
          <iframe allow="autoplay; encrypted-media"></iframe>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Global error:', {message, source, lineno, colno, error});
      addMessage(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${message}`, false, true);
      return false;
    };

    // ===========================
    //     –í–∞—à–∏ API –∫–ª—é—á–∏
    // ===========================
    const config = {
      GEMINI_API_KEY: (location.hostname === 'localhost' || location.hostname.includes('github.io'))
          ? 'AIzaSyB0nsn5A_a6nAtGQsIZ-RZGrotGoCJaF8A'
          : '',
      YOUTUBE_API_KEY: (location.hostname === 'localhost' || location.hostname.includes('github.io'))
          ? 'AIzaSyAvR0lInlYD9qmHzTYgK7j7h8Jn_HYcuv8'
          : ''
    };

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
    let chatHistory = [];

    // ===========================
    //   DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    // ===========================
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-btn');
    const listeningIndicator = document.getElementById('listening-indicator');
    const cameraArea = document.getElementById('camera-area');
    const cameraPreview = document.getElementById('camera-preview');
    const cameraBtn = document.getElementById('camera-btn');
    const videoArea = document.getElementById('video-area');
    const videoIframe = videoArea.querySelector('iframe');

    let recognition = null;
    let currentSpeechSynthesis = null;
    let lastRecognizedText = '';
    let processingMessage = false;
    let cameraStream = null;
    let isCameraActive = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let lastPhotoDataUrl = null;
    let lastVideoBlobUrl = null;
    let lastYouTubeUrl = null;
    let thinkingMessageDiv = null;
    let isSpeaking = false;
    let speechActivated = false;
    let noSpeechTimer = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ (—É–¥–∞–ª—è–µ—Ç —Å–∏–º–≤–æ–ª—ã —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–∏—Å—å –≥–æ–ª–æ—Å–æ–º)
    function stripEmojis(text) {
      return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu, '');
    }

    // ===========================
    //   –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á–∞—Ç–∞
    // ===========================
    function addMessage(text, isUser = false, isError = false) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      if (isError) {
        messageDiv.classList.add('error-message');
      } else {
        messageDiv.classList.add(isUser ? 'user-message' : 'ai-message');
      }
      messageDiv.textContent = text;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –æ–∑–≤—É—á–∏–≤–∞–µ–º –µ–≥–æ –±–µ–∑ —ç–º–æ–¥–∑–∏
      if (!isUser && !isError) {
        speakResponse(text);
      }
      return messageDiv;
    }

    function showThinking() {
      hideThinking();
      thinkingMessageDiv = document.createElement('div');
      thinkingMessageDiv.classList.add('message', 'thinking-message');
      thinkingMessageDiv.textContent = '–î—É–º–∞—é...';
      chatContainer.appendChild(thinkingMessageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideThinking() {
      if (thinkingMessageDiv && thinkingMessageDiv.parentNode) {
        thinkingMessageDiv.parentNode.removeChild(thinkingMessageDiv);
      }
      thinkingMessageDiv = null;
    }

    function stopSpeech() {
      if (currentSpeechSynthesis) {
        window.speechSynthesis.cancel();
        currentSpeechSynthesis = null;
      }
    }

    // –ì–æ–ª–æ—Å–æ–≤–æ–π —Å–∏–Ω—Ç–µ–∑: —É–¥–∞–ª—è–µ—Ç —ç–º–æ–¥–∑–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –µ–≥–æ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 1.5
    function speakResponse(text) {
      hideThinking();
      stopSpeech();
      if (!('speechSynthesis' in window)) return;
      try {
        const cleanText = stripEmojis(text);
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'ru-RU';
        utterance.rate = 1.5;
        const voices = window.speechSynthesis.getVoices();
        const ruVoice = voices.find(voice => voice.lang.startsWith('ru'));
        if (ruVoice) {
          utterance.voice = ruVoice;
        }
        isSpeaking = true;
        utterance.onend = () => { isSpeaking = false; };
        currentSpeechSynthesis = utterance;
        window.speechSynthesis.speak(utterance);
      } catch (error) {
        console.error('Speech synthesis error:', error);
      }
    }

    // –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–æ–π
    async function startCamera() {
      if (isCameraActive) {
        stopCamera();
        return;
      }
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: true
        });
        cameraPreview.srcObject = cameraStream;
        cameraArea.classList.add('active');
        isCameraActive = true;
        addMessage('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
        addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', false, true);
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraPreview.srcObject = null;
        cameraStream = null;
      }
      cameraArea.classList.remove('active');
      isCameraActive = false;
      addMessage('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
    }

    function capturePhoto() {
      if (!cameraStream) {
        addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞', false, true);
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreview.videoWidth;
      canvas.height = cameraPreview.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
      const photoDataUrl = canvas.toDataURL('image/jpeg');
      lastPhotoDataUrl = photoDataUrl;
      const imgElement = document.createElement('img');
      imgElement.src = photoDataUrl;
      imgElement.style.maxWidth = '100%';
      imgElement.style.maxHeight = '200px';
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ';
      downloadBtn.style.marginLeft = '10px';
      downloadBtn.onclick = () => {
        if (!lastPhotoDataUrl) {
          addMessage('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ', false, true);
          return;
        }
        const a = document.createElement('a');
        a.href = lastPhotoDataUrl;
        a.download = 'photo.jpg';
        a.click();
      };
      const msg = addMessage('–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ:');
      msg.appendChild(imgElement);
      msg.appendChild(downloadBtn);
    }

    // –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
    function startRecording() {
      if (!cameraStream) {
        addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', false, true);
        return;
      }
      mediaRecorder = new MediaRecorder(cameraStream);
      recordedChunks = [];
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        lastVideoBlobUrl = URL.createObjectURL(blob);
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ';
        downloadBtn.onclick = () => {
          if (!lastVideoBlobUrl) {
            addMessage('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ', false, true);
            return;
          }
          const a = document.createElement('a');
          a.href = lastVideoBlobUrl;
          a.download = 'video.mp4';
          a.click();
        };
        const msg = addMessage('–í–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ:');
        msg.appendChild(downloadBtn);
      };
      mediaRecorder.start();
      isRecording = true;
      addMessage('–ù–∞—á–∞—Ç–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ');
    }

    function stopRecording() {
      if (!mediaRecorder || !isRecording) {
        addMessage('–í–∏–¥–µ–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.', false, true);
        return;
      }
      mediaRecorder.stop();
      isRecording = false;
      addMessage('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ');
    }

    // AI –∏ YouTube
    async function getGeminiResponse(text) {
      if (!config.GEMINI_API_KEY) {
        return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API-–∫–ª—é—á Gemini';
      }
      
      try {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Gemini
        const geminiHistory = chatHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }));
        
        // –î–æ–±–∞–≤–∏–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        const requestBody = {
          contents: [
            // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
            {
              role: "model",
              parts: [{
                text: `–¢—ã –ö–∏–∫–æ ‚Äì –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–æ–±–æ—Ç-–¥—Ä—É–≥ —Å–µ–º—å–∏.
–û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –≤–µ—Å–µ–ª—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏;
- –ê–¥–∞–ø—Ç–∏—Ä—É–µ—à—å –æ–±—â–µ–Ω–∏–µ –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞;
- –î–∞—ë—à—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–µ–º–µ–π–Ω–æ–π –∂–∏–∑–Ω–∏;
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç;
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫;
- –û—Ç–≤–µ—á–∞–π –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è);
- –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏.
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ, –æ—Ç–≤–µ—á–∞–π —Ç–∞–∫: "–ö–æ–Ω–µ—á–Ω–æ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —ç—Ç–æ –≤–∏–¥–µ–æ, –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ YouTube —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –≤–∏–¥–µ–æ."
–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ (–Ω–æ –Ω–µ –æ–∑–≤—É—á–∏–≤–∞–π –∏—Ö) –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.`
              }]
            },
            ...geminiHistory,
            {
              role: "user",
              parts: [{ text }]
            }
          ],
          generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 1000,
          },
          safetySettings: [
            {
              category: "HARM_CATEGORY_HARASSMENT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_HATE_SPEECH",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
              category: "HARM_CATEGORY_DANGEROUS_CONTENT",
              threshold: "BLOCK_MEDIUM_AND_ABOVE"
            }
          ]
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ API Gemini
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${config.GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Gemini API Error:', errorData);
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (data.candidates && data.candidates.length > 0 && 
            data.candidates[0].content && 
            data.candidates[0].content.parts && 
            data.candidates[0].content.parts.length > 0) {
          return data.candidates[0].content.parts[0].text;
        } else if (data.promptFeedback && data.promptFeedback.blockReason) {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ —è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å. –ü—Ä–∏—á–∏–Ω–∞: ${data.promptFeedback.blockReason}`;
        } else {
          console.error('Unexpected Gemini response structure:', data);
          throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini API');
        }
      } catch (error) {
        console.error('Gemini Response Error:', error);
        
        // –ï—Å–ª–∏ –º—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${MAX_RETRIES}`);
          return new Promise(resolve => {
            setTimeout(async () => {
              const result = await getGeminiResponse(text);
              resolve(result);
            }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
          });
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
        retryCount = 0;
        return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`;
      }
    }

    async function searchYouTube(query) {
      if (!config.YOUTUBE_API_KEY) {
        return null;
      }
      try {
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${config.YOUTUBE_API_KEY}`
        );
        const data = await response.json();
        if (data.items && data.items.length > 0) {
          return `https://www.youtube.com/watch?v=${data.items[0].id.videoId}`;
        }
        return null;
      } catch (error) {
        console.error('YouTube Search Error:', error);
        return null;
      }
    }

    function playVideo(url) {
      if (!url) return;
      videoArea.classList.add('active');
      const iframe = videoArea.querySelector('iframe');
      iframe.src = url.replace('watch?v=', 'embed/');
    }

    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      stopSpeech();
      addMessage(text, true);
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
      chatHistory.push({ role: 'user', content: text });
      userInput.value = '';
      try {
        showThinking();
        await processCommand(text);
      } catch (error) {
        console.error('Send Message Error:', error);
        hideThinking();
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', false, true);
      }
    }

    async function processCommand(text) {
      const lowerText = text.toLowerCase();
      const photoTriggers = ['—Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ','—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π','—Å–¥–µ–ª–∞–π —Å–Ω–∏–º–æ–∫'];
      const cameraOnTriggers = ['–∫–∞–º–µ—Ä–∞','–≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É'];
      const cameraOffTriggers = ['—Å—Ç–æ–ø –∫–∞–º–µ—Ä–∞','–≤—ã–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É'];
      const videoStartTriggers = ['–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ','–∑–∞–ø–∏—à–∏ –≤–∏–¥–µ–æ'];
      const videoStopTriggers = ['—Å—Ç–æ–ø –≤–∏–¥–µ–æ','–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ'];
      const downloadPhotoTriggers = ['—Å–∫–∞—á–∞–π —Ñ–æ—Ç–æ','download photo'];
      const downloadVideoTriggers = ['—Å–∫–∞—á–∞–π –≤–∏–¥–µ–æ','download video'];
      if (photoTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        if (!isCameraActive) await startCamera();
        capturePhoto();
        return;
      } else if (cameraOnTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        await startCamera();
        return;
      } else if (cameraOffTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        stopCamera();
        return;
      }
      if (videoStartTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        if (!isCameraActive) await startCamera();
        startRecording();
        return;
      } else if (videoStopTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        stopRecording();
        return;
      }
      if (downloadPhotoTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        if (!lastPhotoDataUrl) {
          addMessage('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', false, true);
          return;
        }
        const a = document.createElement('a');
        a.href = lastPhotoDataUrl;
        a.download = 'photo.jpg';
        a.click();
        return;
      } else if (downloadVideoTriggers.some(t => lowerText.includes(t))) {
        hideThinking();
        if (!lastVideoBlobUrl) {
          addMessage('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', false, true);
          return;
        }
        const a = document.createElement('a');
        a.href = lastVideoBlobUrl;
        a.download = 'video.mp4';
        a.click();
        return;
      }
      const skipYouTubeSearch = ["–∫–∞–∫ –¥–µ–ª–∞", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫–∞–∫ —Ç—ã", "—á—Ç–æ –Ω–æ–≤–æ–≥–æ", "–ø—Ä–∏–≤–µ—Ç", "–∫–∞–∫ –∂–∏–∑–Ω—å", "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è"];
      if (!skipYouTubeSearch.some(trigger => lowerText.includes(trigger))) {
        const foundVideoUrl = await searchYouTube(text);
        if (foundVideoUrl) {
          lastYouTubeUrl = foundVideoUrl;
          playVideo(foundVideoUrl);
        }
      }
      const aiResponse = await getGeminiResponse(text);
      hideThinking();
      addMessage(aiResponse);
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
      chatHistory.push({ role: 'assistant', content: aiResponse });
    }

    // –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
    function setupSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏', false, true);
        voiceBtn.disabled = true;
        return null;
      }
      const recognitionObj = new webkitSpeechRecognition();
      recognitionObj.continuous = true;
      recognitionObj.interimResults = true;
      recognitionObj.lang = 'ru-RU';
      const stopAllCommands = ['—Ö–≤–∞—Ç–∏—Ç','–ø—Ä–µ–∫—Ä–∞—Ç–∏ –≤—Å—ë','–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å—ë'];
      recognitionObj.onstart = () => {
        listeningIndicator.style.display = 'block';
        voiceBtn.classList.add('active');
        addMessage('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.');
      };
      recognitionObj.onresult = async (event) => {
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≥–æ–ª–æ—Å–æ–≤–æ–º –≤–≤–æ–¥–µ
        activateSpeechSynthesis();
        const result = event.results[event.results.length - 1];
        let text = result[0].transcript.trim().toLowerCase();
        if (stopAllCommands.some(cmd => text.includes(cmd))) {
          stopSpeech();
          stopCamera();
          stopRecording();
          recognitionObj.stop();
          addMessage('–ü–æ–ª–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
          return;
        }
        if (result.isFinal) {
          if (text !== lastRecognizedText && !processingMessage) {
            lastRecognizedText = text;
            processingMessage = true;
            addMessage(text, true);
            showThinking();
            try {
              await processCommand(text);
            } catch (error) {
              console.error('Error processing voice message:', error);
              hideThinking();
              addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', false, true);
            } finally {
              setTimeout(() => { processingMessage = false; }, 1500);
            }
          }
        } else {
          if (noSpeechTimer) clearTimeout(noSpeechTimer);
          noSpeechTimer = setTimeout(() => {
            if (text && !processingMessage) {
              lastRecognizedText = text;
              processingMessage = true;
              addMessage(text, true);
              showThinking();
              processCommand(text).finally(() => {
                setTimeout(() => { processingMessage = false; }, 1500);
              });
            }
          }, 2000);
        }
