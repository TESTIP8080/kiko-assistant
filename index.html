<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <!-- Permissions-Policy ‚Äî –Ω–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å -->
  <meta name="permissions-policy" content="microphone=(self), camera=(self)">
  <!-- CORS-–º–µ—Ç–∞ -->
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, OPTIONS">
  <meta http-equiv="Access-Control-Allow-Headers" content="Content-Type, Authorization">

  <title>KiKo Beam - Intelligent Chat Assistant</title>

  <style>
    :root {
      --bg-primary: #1e1e1e;
      --text-primary: #ffffff;
      --accent-color: #bb86fc;
      --secondary-color: #03dac6;
      --panel-bg: #2c2c2c;
      --border-radius: 10px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .header {
      background-color: var(--panel-bg);
      padding: 10px 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .header h1 {
      margin: 0;
      color: var(--accent-color);
      font-size: 1.5rem;
    }
    .app-container {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
      gap: 10px;
      padding: 10px;
    }
    .chat-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      position: relative;
      overflow: hidden;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: rgba(255,255,255,0.05);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .message {
      max-width: 80%;
      margin: 6px 0;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .user-message {
      background-color: var(--accent-color);
      align-self: flex-end;
      margin-left: auto;
      color: #000;
    }
    .ai-message {
      background-color: rgba(255,255,255,0.1);
      align-self: flex-start;
    }
    .error-message {
      color: #ff4b4b;
      background-color: rgba(255,0,0,0.2);
    }
    .thinking-message {
      font-style: italic;
      opacity: 0.8;
    }
    #input-container {
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex-grow: 1;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      border-radius: 5px;
    }
    #send-btn, #voice-btn, #restart-mic-btn, #voice-config-btn {
      background-color: var(--secondary-color);
      color: var(--bg-primary);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    #restart-mic-btn {
      background-color: #ff6b6b;
      color: white;
    }
    #voice-config-btn {
      background-color: #777;
      color: white;
    }
    #voice-btn.active {
      background-color: red;
      color: white;
    }
    #listening-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: red;
      animation: pulse 1.5s infinite;
      position: absolute;
      top: 15px;
      right: 15px;
      display: none;
    }
    #volume-meter {
      display: none; 
      width: 150px; 
      height: 15px; 
      background: #333; 
      position: absolute; 
      top: 40px; 
      right: 15px; 
      border-radius: 7px; 
      overflow: hidden;
    }
    #volume-level {
      height: 100%; 
      width: 0%; 
      background: linear-gradient(to right, green, yellow, red); 
      transition: width 0.1s;
    }
    .recognition-status {
      font-size: 12px;
      color: #aaa;
      position: absolute;
      top: 15px;
      left: 15px;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    .media-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .media-container {
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      height: calc(50% - 5px);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .media-container h4 {
      margin-bottom: 10px;
    }
    #camera-area, #video-area {
      flex: 1;
      display: none;
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
      background-color: #000;
    }
    #camera-area.active,
    #video-area.active {
      display: flex;
      flex-direction: column;
    }
    #camera-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #camera-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    #video-area iframe {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: var(--border-radius);
      border: none;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è YouTube */
    .youtube-controls {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .youtube-controls button {
      flex: 1;
      padding: 5px 10px;
      background-color: var(--accent-color);
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
    /* Android-TV */
    @media (hover: none) {
      #send-btn, #voice-btn {
        padding: 15px 30px;
        font-size: 1.2em;
        transition: none;
      }
      #send-btn:focus, #voice-btn:focus {
        outline: 3px solid var(--accent-color);
        transform: scale(1.1);
      }
      #user-input:focus {
        outline: 3px solid var(--accent-color);
      }
    }
  </style>
  
  <script>
    /* --- HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç --- */
    if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost')) {
      window.location.href = window.location.href.replace('http:', 'https:');
    }

    /* --- –û–ø—Ä–µ–¥–µ–ª—è–µ–º Android-TV --- */
    const isAndroidTV = navigator.userAgent.toLowerCase().includes('android tv') ||
                        navigator.userAgent.toLowerCase().includes('smart tv');

    function initForTV() {
      document.documentElement.style.fontSize = '24px';
      const style = document.createElement('style');
      style.textContent = `
        button:hover { transform: none !important; opacity: 1 !important; }
        #send-btn, #voice-btn { padding: 15px 30px; font-size: 1.2em; }
        #user-input { font-size: 1.2em; padding: 15px; }
      `;
      document.head.appendChild(style);
      document.querySelectorAll('button').forEach(btn => btn.setAttribute('tabindex', '0'));
      userInput.setAttribute('tabindex', '0');
    }
  </script>
</head>

<body>
  <div class="header">
    <h1>KiKo Beam</h1>
  </div>
  
  <div class="app-container">
    <!-- –ß–∞—Ç -->
    <div class="chat-panel">
      <div id="listening-indicator"></div>
      <div id="volume-meter">
        <div id="volume-level"></div>
      </div>
      <div class="recognition-status" id="recognition-status"></div>
      <div id="chat-container"></div>
      <div id="input-container">
        <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
        <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="voice-btn">üé§</button>
      </div>
    </div>

    <!-- –ö–∞–º–µ—Ä–∞ –∏ YouTube -->
    <div class="media-panel">
      <div class="media-container">
        <h4>–ö–∞–º–µ—Ä–∞</h4>
        <div id="camera-area">
          <video id="camera-preview" autoplay muted></video>
          <button id="camera-btn">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
      </div>
      <div class="media-container">
        <h4>YouTube</h4>
        <div id="video-area">
          <iframe id="youtube-iframe" allow="autoplay; encrypted-media"></iframe>
          <div class="youtube-controls">
            <button id="youtube-play">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
            <button id="youtube-search">üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ --- */
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Global error:', {message, source, lineno, colno, error});
      addMessage(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ ${lineno}: ${message}`, false, true);
      return false;
    };

    /* --- API-–∫–ª—é—á–∏ --- */
    const config = {
      GEMINI_API_KEY: (location.hostname === 'localhost' || location.hostname.includes('github.io'))
          ? 'AIzaSyB0nsn5A_a6nAtGQsIZ-RZGrotGoCJaF8A' : '',
      YOUTUBE_API_KEY: (location.hostname === 'localhost' || location.hostname.includes('github.io'))
          ? 'AIzaSyDt1cRmHyYNEPnu78Wt4Y_RgXNhKwD2Q44' : ''
    };
	
	/* --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è --- */
    let chatHistory = [];
    const chatContainer = document.getElementById('chat-container');
    const userInput     = document.getElementById('user-input');
    const sendBtn       = document.getElementById('send-btn');
    const voiceBtn      = document.getElementById('voice-btn');
    const listeningIndicator = document.getElementById('listening-indicator');
    const volumeMeter = document.getElementById('volume-meter');
    const volumeLevel = document.getElementById('volume-level');
    const recognitionStatus = document.getElementById('recognition-status');

    const cameraArea    = document.getElementById('camera-area');
    const cameraPreview = document.getElementById('camera-preview');
    const cameraBtn     = document.getElementById('camera-btn');

    const videoArea     = document.getElementById('video-area');
    const videoIframe   = document.getElementById('youtube-iframe');
    const youtubePlayBtn = document.getElementById('youtube-play');
    const youtubeSearchBtn = document.getElementById('youtube-search');

    let recognition = null;
    let currentSpeechSynthesis = null;
    let lastRecognizedText = '';
    let processingMessage = false;
    let cameraStream = null;
    let isCameraActive = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let lastPhotoDataUrl = null;
    let lastVideoBlobUrl = null;
    let lastYouTubeUrl = null;
    let lastYouTubeQuery = '';
    let thinkingMessageDiv = null;
    let isSpeaking = false;
    let noSpeechTimer = null;
    let restartRecognitionTimer = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ YouTube –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
    let waitingForYouTubeQuery = false;
    let speechRecognitionPause = false;
    let speechFinalTimeout = null;
    let recognitionInProgress = false;
    let forceMicRestart = false;
    
    // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
    let youtubePlayerState = 'stopped'; // 'playing', 'paused', 'stopped'
    let lastCommand = ''; // –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let audioStream = null;
    let speechActivated = false;

    /* --- –£—Ç–∏–ª–∏—Ç—ã --- */
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –∏—Ö –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
    function stripEmojis(text) {
      // –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∏ —Å–º–∞–π–ª–∏–∫–æ–≤
      const cleanText = text
        // –£–¥–∞–ª—è–µ–º Unicode —ç–º–æ–¥–∑–∏
        .replace(/[\u{1F000}-\u{1FFFF}\u{2600}-\u{27FF}\u{2B00}-\u{2BFF}]/gu, '')
        // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–º–∞–π–ª–∏–∫–∏
        .replace(/[:;]-?[)D(PpOo]/g, '') 
        // –£–¥–∞–ª—è–µ–º —ç–º–æ–¥–∑–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ Unicode –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
        .replace(/[\u{FE00}-\u{FE0F}\u{E0100}-\u{E01EF}]/gu, '')
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ —ç–º–æ–¥–∑–∏ 
        .replace(/[‚ù§‚ú®üôèüëçüëãüëè]/gu, '');
        
      return cleanText;
    }

    function addMessage(text, isUser=false, isError=false) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      if (isError) {
        messageDiv.classList.add('error-message');
      } else {
        messageDiv.classList.add(isUser ? 'user-message' : 'ai-message');
      }
      messageDiv.textContent = text;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      if (!isUser && !isError) speakResponse(text);
      return messageDiv;
    }

    function showThinking() {
      hideThinking();
      thinkingMessageDiv = document.createElement('div');
      thinkingMessageDiv.classList.add('message', 'thinking-message');
      thinkingMessageDiv.textContent = '–î—É–º–∞—é...';
      chatContainer.appendChild(thinkingMessageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function hideThinking() {
      if (thinkingMessageDiv && thinkingMessageDiv.parentNode)
        thinkingMessageDiv.parentNode.removeChild(thinkingMessageDiv);
      thinkingMessageDiv = null;
    }
    
    function stopSpeech() {
      if (currentSpeechSynthesis) {
        window.speechSynthesis.cancel();
        currentSpeechSynthesis = null;
      }
      isSpeaking = false;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    function updateRecognitionStatus(status) {
      recognitionStatus.textContent = status;
    }

    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤
    function activateSpeechSynthesis() {
      if (!speechActivated && 'speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(' ');
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∏–∑–∫—É—é –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–ª—è –±–µ–∑–∑–≤—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        utterance.volume = 0.1;
        window.speechSynthesis.speak(utterance);
        speechActivated = true;
      }
    }
	
	// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
    function speakResponse(text) {
      hideThinking();
      stopSpeech();
      if (!('speechSynthesis' in window)) return;
      
      try {
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–∏–Ω—Ç–µ–∑–∞
        if (recognition && recognition._isRunning) {
          recognition.stop();
          // –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è
          recognition._tempStop = true;
        }
        
        // –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —ç–º–æ–¥–∑–∏
        const cleanText = stripEmojis(text);
        console.log("–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç:", text);
        console.log("–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏:", cleanText);
        
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'ru-RU';
        utterance.rate = 1.2; // –ù–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∑–∏–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–∑–±–æ—Ä—á–∏–≤–æ—Å—Ç–∏
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å
        const voices = window.speechSynthesis.getVoices();
        const ruVoice = voices.find(v => v.lang.startsWith('ru'));
        if (ruVoice) {
          console.log("–ù–∞–π–¥–µ–Ω —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å:", ruVoice.name);
          utterance.voice = ruVoice;
        } else {
          console.log("–†—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
        }
        
        isSpeaking = true;
        updateRecognitionStatus('–ì–æ–≤–æ—Ä—é...');
        
        utterance.onend = () => { 
          isSpeaking = false;
          updateRecognitionStatus('–ì–æ—Ç–æ–≤ —Å–ª—É—à–∞—Ç—å');
          
          // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–≤–æ—Ä–µ–Ω–∏—è
          setTimeout(() => {
            if (recognition && !recognition._isRunning && !recognition._manualStop) {
              console.log("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ–∑–≤—É—á–∫–∏");
              try { 
                recognition.start(); 
              } catch(e) { 
                console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ —Ä–µ—á–∏:", e); 
              }
            }
          }, 500);
        };
        
        currentSpeechSynthesis = utterance;
        window.speechSynthesis.speak(utterance);
      } catch(err) {
        console.error('Speech synthesis error:', err);
        isSpeaking = false;
        updateRecognitionStatus('–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è');
      }
    }

    /* --- –ö–∞–º–µ—Ä–∞ --- */
    async function startCamera() {
      if (isCameraActive) { 
        stopCamera(); 
        return; 
      }
      
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {width:{ideal:1280}, height:{ideal:720}}, 
          audio: true
        });
        cameraPreview.srcObject = cameraStream;
        cameraArea.classList.add('active');
        isCameraActive = true;
        addMessage('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');
      } catch(err) {
        console.error('Camera error:', err);
        addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', false, true);
      }
    }
    
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraPreview.srcObject = null;
        cameraStream = null;
      }
      cameraArea.classList.remove('active');
      isCameraActive = false;
      addMessage('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
    }
    
    function capturePhoto() {
      if (!cameraStream) { 
        addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞', false, true); 
        return; 
      }
      
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreview.videoWidth;
      canvas.height = cameraPreview.videoHeight;
      canvas.getContext('2d').drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
      lastPhotoDataUrl = canvas.toDataURL('image/jpeg');
      
      const img = document.createElement('img');
      img.src = lastPhotoDataUrl;
      img.style.maxWidth='100%'; 
      img.style.maxHeight='200px';
      
      const dl = document.createElement('button');
      dl.textContent='–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ';
      dl.style.marginLeft='10px';
      dl.onclick = () => {
        if (!lastPhotoDataUrl) {
          addMessage('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ', false, true);
          return;
        }
        const a = document.createElement('a'); 
        a.href = lastPhotoDataUrl; 
        a.download = 'photo.jpg'; 
        a.click(); 
      };
      
      const msg = addMessage('–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ:'); 
      msg.appendChild(img); 
      msg.appendChild(dl);
    }

    /* --- –í–∏–¥–µ–æ --- */
    function startRecording() {
      if (!cameraStream) { 
        addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', false, true); 
        return; 
      }
      
      mediaRecorder = new MediaRecorder(cameraStream);
      recordedChunks = []; 
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, {type: 'video/mp4'});
        lastVideoBlobUrl = URL.createObjectURL(blob);
        
        const dl = document.createElement('button');
        dl.textContent = '–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ';
        dl.onclick = () => {
          if (!lastVideoBlobUrl) {
            addMessage('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ', false, true);
            return;
          }
          const a = document.createElement('a'); 
          a.href = lastVideoBlobUrl; 
          a.download = 'video.mp4'; 
          a.click();
        };
        
        const msg = addMessage('–í–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ:');
        msg.appendChild(dl);
      };
      
      mediaRecorder.start(); 
      isRecording = true; 
      addMessage('–ù–∞—á–∞—Ç–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ');
    }
    
    function stopRecording() {
      if (!mediaRecorder || !isRecording) { 
        addMessage('–í–∏–¥–µ–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.', false, true); 
        return; 
      }
      
      mediaRecorder.stop(); 
      isRecording = false; 
      addMessage('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ');
    }
	
	/* --- YouTube —Ñ—É–Ω–∫—Ü–∏–∏ --- */
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ YouTube 
    async function searchYouTube(query, isReplay = false) {
      if (!config.YOUTUBE_API_KEY) return null;
      
      try {
        // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–∏–¥–µ–æ
        if (isReplay && lastYouTubeUrl) {
          return lastYouTubeUrl;
        }
        
        // –£–ª—É—á—à–∞–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        const enhancedQuery = query + (!query.toLowerCase().includes('–º—É–∑—ã–∫') ? ' –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å–º' : '');
        console.log("–ü–æ–∏—Å–∫ YouTube:", enhancedQuery);
        
        const res = await fetch(
          `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(enhancedQuery)}&type=video&key=${config.YOUTUBE_API_KEY}&maxResults=5&relevanceLanguage=ru`
        );
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É 401 (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø)
        if (res.status === 401) {
          console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ YouTube API (401)');
          addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ YouTube API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á.', false, true);
          return null;
        }
        
        if (!res.ok) {
          throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${res.status}`);
        }
        
        const data = await res.json();
        
        if (!data.items || data.items.length === 0) {
          console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å");
          const simpleRes = await fetch(
            `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${config.YOUTUBE_API_KEY}&maxResults=5`
          );
          
          if (!simpleRes.ok) {
            throw new Error(`HTTP –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ! –°—Ç–∞—Ç—É—Å: ${simpleRes.status}`);
          }
          
          const simpleData = await simpleRes.json();
          if (simpleData.items?.[0]) return `https://www.youtube.com/watch?v=${simpleData.items[0].id.videoId}`;
          return null;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const isMusicQuery = query.toLowerCase().includes('–º—É–∑—ã–∫') || 
                            query.toLowerCase().includes('–ø–µ—Å–Ω') || 
                            query.toLowerCase().includes('–∫–ª–∏–ø');
        
        let bestResult = data.items[0];
        
        // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –æ –º—É–∑—ã–∫–µ, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –≤–∏–¥–µ–æ
        if (!isMusicQuery) {
          // –ò—â–µ–º –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–ª–∏–ø
          const nonMusicVideo = data.items.find(item => {
            const title = item.snippet.title.toLowerCase();
            const channel = item.snippet.channelTitle.toLowerCase();
            
            // –ò—Å–∫–ª—é—á–∞–µ–º –æ—á–µ–≤–∏–¥–Ω—ã–µ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ
            return !title.includes('–∫–ª–∏–ø') && 
                  !title.includes('music video') && 
                  !title.includes('official video') &&
                  !channel.includes('music') &&
                  !channel.includes('vevo');
          });
          
          if (nonMusicVideo) {
            bestResult = nonMusicVideo;
            console.log("–ù–∞–π–¥–µ–Ω–æ –Ω–µ–º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ:", bestResult.snippet.title);
          }
        }
        
        return `https://www.youtube.com/watch?v=${bestResult.id.videoId}`;
      } catch(err) {
        console.error('YouTube API error:', err);
        addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤–∏–¥–µ–æ –Ω–∞ YouTube. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', false, true);
        return null;
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è YouTube
    function playVideo(url) {
      if(!url) return false;
      
      videoArea.classList.add('active');
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Å autoplay=1 –∏ enablejsapi=1 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
      const embedUrl = url.replace('watch?v=', 'embed/') + '?autoplay=1&enablejsapi=1';
      videoIframe.src = embedUrl;
      youtubePlayerState = 'playing';
      console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∏–¥–µ–æ:", embedUrl);
      return true;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ
    function stopYouTubeVideo() {
      if (!lastYouTubeUrl) return false;
      
      try {
        if (videoIframe.contentWindow) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º postMessage –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–µ–µ—Ä–æ–º
          videoIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
          youtubePlayerState = 'paused';
          return true;
        }
      } catch(e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–∏–¥–µ–æ:", e);
      }
      
      return false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ
    function continueYouTubeVideo() {
      if (!lastYouTubeUrl) return false;
      
      try {
        if (videoIframe.contentWindow) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º postMessage –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–µ–µ—Ä–æ–º
          videoIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
          youtubePlayerState = 'playing';
          return true;
        }
      } catch(e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –≤–∏–¥–µ–æ:", e);
      }
      
      return false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–¥–µ–æ
    function playCurrentYouTube() {
      if (lastYouTubeUrl) {
        playVideo(lastYouTubeUrl);
        addMessage(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è: "${lastYouTubeQuery}"`);
      } else {
        addMessage('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–¥–µ–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ YouTube
    function initiateNewYouTubeSearch() {
      waitingForYouTubeQuery = true;
      addMessage('–ö–∞–∫–æ–µ –≤–∏–¥–µ–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?');
    }
	
	/* --- Gemini API --- */
    async function getGeminiResponse(text) {
      if (!config.GEMINI_API_KEY) return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API-–∫–ª—é—á Gemini';

      try {
        const geminiHistory = chatHistory.map(m => ({
          role: m.role === 'user' ? 'user' : 'model',
          parts: [{text: m.content}]
        }));

        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è YouTube –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const videoStatusText = youtubePlayerState === 'playing' 
            ? `–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${lastYouTubeQuery}".` 
            : lastYouTubeQuery 
                ? `–ù–µ–¥–∞–≤–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–µ–ª –≤–∏–¥–µ–æ –Ω–∞ —Ç–µ–º—É "${lastYouTubeQuery}".` 
                : '';
        
        // –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø GEMINI!
        const contextPrompt = `
          ${videoStatusText}
          
          –í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –í–ò–î–ï–û:
          1. –Ø –ú–û–ì–£ –ü–û–ö–ê–ó–´–í–ê–¢–¨ –í–ò–î–ï–û –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
          2. –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ú–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ –≤ YouTube" –∏–ª–∏ "–û—Ç–∫—Ä–æ–π YouTube".
          3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –≤–∏–¥–µ–æ, –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
             "–í–∫–ª—é—á–∞—é –≤–∏–¥–µ–æ –ø—Ä–æ [—Ç–µ–º–∞]!" - —ç—Ç–æ –ó–ê–ü–£–°–¢–ò–¢ –≤–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
          4. –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
             - "–í–∫–ª—é—á–∞—é –≤–∏–¥–µ–æ –ø—Ä–æ –ì–∞—Ä–∏–∫–∞ –•–∞—Ä–ª–∞–º–æ–≤–∞! –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞! üòÑ"
             - "–°–µ–π—á–∞—Å –Ω–∞–π–¥—É –≤–∏–¥–µ–æ –ø—Ä–æ —Å–∫–∞–∑–∫–∏ –Ω–∞ –Ω–æ—á—å!"
             - "–ó–∞–ø—É—Å–∫–∞—é –≤–∏–¥–µ–æ —Å —Ç–∞–Ω—Ü–∞–º–∏!"
          5. –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ —Ç–∞–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤–∏–¥–µ–æ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
          6. –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
             - "–ø–∞—É–∑–∞" –∏–ª–∏ "–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ" - –¥–ª—è –ø–∞—É–∑—ã
             - "–ø—Ä–æ–¥–æ–ª–∂–∏ –≤–∏–¥–µ–æ" –∏–ª–∏ "–∏–≥—Ä–∞–π" - –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
             - "–ø–æ–∫–∞–∂–∏ —Ç–æ –∂–µ –≤–∏–¥–µ–æ –µ—â—ë —Ä–∞–∑" - –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
        `;

        const body = {
          contents: [
            { 
              role: "model", 
              parts: [{
                text: `–¢—ã –ö–∏–∫–æ ‚Äì –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–æ–±–æ—Ç-–¥—Ä—É–≥ —Å–µ–º—å–∏.
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω;
- –ê–¥–∞–ø—Ç–∏—Ä—É–µ—à—å—Å—è –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç;
- –û—Ç–≤–µ—á–∞–π 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏;
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏;
${contextPrompt}
–ó–∞–≤–µ—Ä—à–∏ –æ—Ç–≤–µ—Ç –ø–æ–∑–∏—Ç–∏–≤–Ω–æ.`
              }]
            },
            ...geminiHistory,
            { role:"user", parts:[{text}] }
          ],
          generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 1000
          },
          safetySettings: [
            {category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE"},
            {category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE"},
            {category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE"},
            {category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE"}
          ]
        };

        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${config.GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
          }
        );
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É 401
        if (res.status === 401) {
          console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Gemini API (401)');
          addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Gemini API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á.', false, true);
          return '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ò–ò. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
        }
        
        if (!res.ok) {
          const err = await res.text();
          console.error('Gemini API error:', err);
          throw new Error(`HTTP —Å—Ç–∞—Ç—É—Å: ${res.status}`);
        }
        
        const data = await res.json();

        if (data.candidates?.[0]?.content?.parts?.[0]) {
          return data.candidates[0].content.parts[0].text;
        }
        
        if (data.promptFeedback?.blockReason) {
          return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${data.promptFeedback.blockReason}`;
        }
        
        throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç Gemini');
      } catch(err) {
        console.error('Gemini error:', err);
        
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount} –∏–∑ ${MAX_RETRIES}`);
          return new Promise(r => setTimeout(async () => r(await getGeminiResponse(text)), 1000));
        }
        
        retryCount = 0;
        return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å.`;
      }
    }

    /* --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ --- */
    async function sendMessage() {
      const text = userInput.value.trim(); 
      if (!text) return;
      
      // –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã
      if (recognition && recognition._isRunning) {
        recognition._tempStop = true;
        recognition.stop();
      }
      
      stopSpeech(); 
      addMessage(text, true);
      chatHistory.push({role: 'user', content: text}); 
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
      if (chatHistory.length > 30) chatHistory.shift();
      userInput.value = ''; 
      showThinking();
      
      try { 
        await processCommand(text); 
      } catch(err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã:', err); 
        hideThinking(); 
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', false, true);
      } finally {
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        if (recognition && recognition._tempStop) {
          recognition._tempStop = false;
          setTimeout(() => {
            try {
              if (!recognition._isRunning && !isSpeaking) {
                recognition.start();
              }
            } catch(e) {
              console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã:", e);
            }
          }, 800);
        }
      }
    }
	
	async function processCommand(text) {
      const lower = text.toLowerCase();
      lastCommand = lower; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      
      // –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–∞–º–µ—Ä—ã –∏ —Ñ–æ—Ç–æ
      const photo = ['—Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ', '—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π', '—Å–¥–µ–ª–∞–π —Å–Ω–∏–º–æ–∫'];
      const camOn = ['–∫–∞–º–µ—Ä–∞', '–≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É'];
      const camOff = ['—Å—Ç–æ–ø –∫–∞–º–µ—Ä–∞', '–≤—ã–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É'];
      const vidStart = ['–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ', '–∑–∞–ø–∏—à–∏ –≤–∏–¥–µ–æ'];
      const vidStop = ['—Å—Ç–æ–ø –≤–∏–¥–µ–æ', '–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ'];
      const dlPhoto = ['—Å–∫–∞—á–∞–π —Ñ–æ—Ç–æ', 'download photo'];
      const dlVideo = ['—Å–∫–∞—á–∞–π –≤–∏–¥–µ–æ', 'download video'];
      const stopAll = ['—Ö–≤–∞—Ç–∏—Ç', '–ø—Ä–µ–∫—Ä–∞—Ç–∏ –≤—Å—ë', '–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å—ë', '—Å—Ç–æ–ø –≤—Å—ë'];

      // –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è YouTube
      const ytStop = ['–æ—Å—Ç–∞–Ω–æ–≤–∏ —é—Ç—É–±', '–ø–∞—É–∑–∞ –≤–∏–¥–µ–æ', '–ø–∞—É–∑–∞', '–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ –Ω–∞ —é—Ç—É–±–µ', '—Å—Ç–æ–ø —é—Ç—É–±'];
      const ytPlay = ['–ø—Ä–æ–¥–æ–ª–∂–∏ –≤–∏–¥–µ–æ', '–ø—Ä–æ–¥–æ–ª–∂–∏ —é—Ç—É–±', '–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–∏ —é—Ç—É–±', '–ø–ª–µ–π', '–∏–≥—Ä–∞–π'];
      const ytReplay = ['–ø–æ–≤—Ç–æ—Ä–∏ –≤–∏–¥–µ–æ', '–ø–æ–∫–∞–∂–∏ –µ—â–µ —Ä–∞–∑', '–≤–∫–ª—é—á–∏ —Ç–æ –∂–µ –≤–∏–¥–µ–æ', '–ø–æ–∫–∞–∂–∏ —Å–Ω–æ–≤–∞', '–µ—â–µ —Ä–∞–∑'];
      
      // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è YouTube (–ù–û–í–û–ï!)
      const ytTriggers = [
        '–≤–∫–ª—é—á –≤–∏–¥–µ–æ', '–≤–∫–ª—é—á–∞—é –≤–∏–¥–µ–æ', '–∑–∞–ø—É—Å–∫–∞—é –≤–∏–¥–µ–æ', '–Ω–∞–π–¥—É –≤–∏–¥–µ–æ',
        '–≤–∫–ª—é—á —Ñ–∏–ª—å–º', '–≤–∫–ª—é—á–∞—é —Ñ–∏–ª—å–º', '–∑–∞–ø—É—Å–∫–∞—é —Ñ–∏–ª—å–º', '–Ω–∞–π–¥—É —Ñ–∏–ª—å–º',
        '–≤–∫–ª—é—á —Ä–æ–ª–∏–∫', '–≤–∫–ª—é—á–∞—é —Ä–æ–ª–∏–∫', '–∑–∞–ø—É—Å–∫–∞—é —Ä–æ–ª–∏–∫', '–Ω–∞–π–¥—É —Ä–æ–ª–∏–∫',
        '–ø–æ—Å—Ç–∞–≤–ª—é –≤–∏–¥–µ–æ', '–ø–æ–∫–∞–∂—É –≤–∏–¥–µ–æ', '–∏—â—É –≤–∏–¥–µ–æ', '—Å–µ–π—á–∞—Å –Ω–∞–π–¥—É –≤–∏–¥–µ–æ'
      ];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ–≥–æ
      if (stopAll.some(t => lower.includes(t))) {
        hideThinking();
        stopSpeech();
        stopCamera();
        stopRecording();
        if (recognition) {
          recognition._manualStop = true;
          recognition.stop();
        }
        addMessage('–í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        return;
      }
      
      if (photo.some(t => lower.includes(t))) {
        hideThinking(); 
        if (!isCameraActive) await startCamera(); 
        capturePhoto(); 
        return;
      }
      
      if (camOn.some(t => lower.includes(t))) {
        hideThinking(); 
        await startCamera(); 
        return;
      }
      
      if (camOff.some(t => lower.includes(t))) {
        hideThinking(); 
        stopCamera(); 
        return;
      }
      
      if (vidStart.some(t => lower.includes(t)) && !lower.includes('—é—Ç—É–±') && !lower.includes('youtube')) {
        hideThinking(); 
        if (!isCameraActive) await startCamera(); 
        startRecording(); 
        return;
      }
      
      if (vidStop.some(t => lower.includes(t))) {
        hideThinking(); 
        stopRecording(); 
        return;
      }
      
      if (dlPhoto.some(t => lower.includes(t))) {
        hideThinking();
        if (!lastPhotoDataUrl) {
          addMessage('–ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', false, true);
          return;
        }
        const a = document.createElement('a');
        a.href = lastPhotoDataUrl;
        a.download = 'photo.jpg';
        a.click();
        addMessage('–§–æ—Ç–æ —Å–∫–∞—á–∞–Ω–æ');
        return;
      }
      
      if (dlVideo.some(t => lower.includes(t))) {
        hideThinking();
        if (!lastVideoBlobUrl) {
          addMessage('–ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', false, true);
          return;
        }
        const a = document.createElement('a');
        a.href = lastVideoBlobUrl;
        a.download = 'video.mp4';
        a.click();
        addMessage('–í–∏–¥–µ–æ —Å–∫–∞—á–∞–Ω–æ');
        return;
      }

      // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ YouTube –≤–∏–¥–µ–æ
      if (ytStop.some(t => lower.includes(t))) {
        hideThinking();
        if (youtubePlayerState === 'playing') {
          if (stopYouTubeVideo()) {
            addMessage('–í–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑–µ');
          } else {
            addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ');
          }
        } else {
          addMessage('–ù–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—â–µ–≥–æ—Å—è –≤–∏–¥–µ–æ');
        }
        return;
      }

      // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ YouTube –≤–∏–¥–µ–æ
      if (ytPlay.some(t => lower.includes(t))) {
        hideThinking();
        if (youtubePlayerState === 'paused') {
          if (continueYouTubeVideo()) {
            addMessage('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–æ');
          } else {
            addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
          }
        } else if (youtubePlayerState === 'stopped' && lastYouTubeUrl) {
          playVideo(lastYouTubeUrl);
          addMessage(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ: "${lastYouTubeQuery}"`);
        } else {
          addMessage('–ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è');
        }
        return;
      }

      // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ YouTube –≤–∏–¥–µ–æ
      if (ytReplay.some(t => lower.includes(t))) {
        hideThinking();
        if (lastYouTubeUrl) {
          playVideo(lastYouTubeUrl);
          addMessage(`–ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—é –≤–∏–¥–µ–æ: "${lastYouTubeQuery}"`);
        } else {
          addMessage('–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞');
        }
        return;
      }
      
      // –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê! –ï—Å–ª–∏ Gemini –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–µ–æ, –º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–º—É
      // –∏ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ
      if (ytTriggers.some(t => lower.includes(t))) {
        hideThinking();
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–º—É –≤–∏–¥–µ–æ –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        let videoTopic = '';
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–∞–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π —Å—Ä–∞–±–æ—Ç–∞–ª
        for (const trigger of ytTriggers) {
          if (lower.includes(trigger)) {
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏ –±–µ—Ä–µ–º –≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ –Ω–µ–≥–æ
            const triggerIndex = lower.indexOf(trigger) + trigger.length;
            let afterTrigger = text.substring(triggerIndex).trim();
            
            // –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø—Ä–æ/–æ/–æ–± –≤ –Ω–∞—á–∞–ª–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            afterTrigger = afterTrigger.replace(/^(–ø—Ä–æ|–æ|–æ–±)\s+/i, '').trim();
            
            // –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏ –∏ —Å–º–∞–π–ª–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ
            afterTrigger = afterTrigger.replace(/[!.?]+\s*[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}].*$/u, '').trim();
            
            if (afterTrigger) {
              videoTopic = afterTrigger;
              console.log("–ò–∑–≤–ª–µ—á–µ–Ω–∞ —Ç–µ–º–∞ –≤–∏–¥–µ–æ:", videoTopic);
              break;
            }
          }
        }
        
        if (videoTopic) {
          addMessage(`–ò—â—É –≤–∏–¥–µ–æ –ø—Ä–æ "${videoTopic}"...`);
          
          const yt = await searchYouTube(videoTopic);
          if (yt) {
            lastYouTubeUrl = yt;
            lastYouTubeQuery = videoTopic;
            if (playVideo(yt)) {
              addMessage(`–ü–æ–∫–∞–∑—ã–≤–∞—é –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${videoTopic}"`);
            } else {
              addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏"');
            }
          } else {
            addMessage(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ –ø—Ä–æ "${videoTopic}"`);
          }
          return;
        }
      }
	  
	  // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è YouTube —Å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
      const youtubeCommands = [
        '–ø–æ–∫–∞–∂–∏ –≤–∏–¥–µ–æ', '–ø–æ–∫–∞–∂–∏ —é—Ç—É–±', '–Ω–∞–π–¥–∏ –≤–∏–¥–µ–æ', '—é—Ç—É–±', 
        '–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ –Ω–∞ —é—Ç—É–±', '–≤–∫–ª—é—á–∏ –≤–∏–¥–µ–æ', '–æ—Ç–∫—Ä–æ–π –≤–∏–¥–µ–æ'
      ];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—Ä—è–º—É—é –∫–æ–º–∞–Ω–¥—É "–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ X" –∏–ª–∏ "–ø–æ–∫–∞–∂–∏ –≤–∏–¥–µ–æ X"
      const directYoutubeRegex = /(–∑–∞–ø—É—Å—Ç–∏|–ø–æ–∫–∞–∂–∏|–Ω–∞–π–¥–∏|–≤–∫–ª—é—á–∏|–æ—Ç–∫—Ä–æ–π)\s+–≤–∏–¥–µ–æ\s+(–ø—Ä–æ|–æ|—Å|–æ–±|)\s*(.+)/i;
      const directMatch = text.match(directYoutubeRegex);
      
      if (directMatch && directMatch[3]) {
        const query = directMatch[3].trim();
        if (query.length > 2) { // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞
          hideThinking();
          addMessage(`–ò—â—É –≤–∏–¥–µ–æ –ø—Ä–æ "${query}"...`);
          
          const yt = await searchYouTube(query);
          if (yt) {
            lastYouTubeUrl = yt;
            lastYouTubeQuery = query;
            if (playVideo(yt)) {
              addMessage(`–ü–æ–∫–∞–∑—ã–≤–∞—é –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);
            } else {
              addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏"');
            }
          } else {
            addMessage(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ: "${query}"`);
          }
          return;
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –¥–ª—è YouTube - –ù–ï –∏—â–µ–º —Å—Ä–∞–∑—É, —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
      if (youtubeCommands.some(cmd => lower.includes(cmd)) && !waitingForYouTubeQuery) {
        hideThinking();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞
        if (lastYouTubeQuery) {
          addMessage(`–ù–µ–¥–∞–≤–Ω–æ –≤—ã —Å–º–æ—Ç—Ä–µ–ª–∏ –≤–∏–¥–µ–æ –ø—Ä–æ "${lastYouTubeQuery}". –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ –∏–ª–∏ –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ?`);
          waitingForYouTubeQuery = true;
          return;
        } else {
          waitingForYouTubeQuery = true;
          addMessage('–ö–∞–∫–æ–µ –≤–∏–¥–µ–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?');
          return;
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –æ –≤–∏–¥–µ–æ
      if (waitingForYouTubeQuery) {
        waitingForYouTubeQuery = false;
        hideThinking();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ
        const repeatKeywords = ['—Å–Ω–æ–≤–∞', '–ø–æ–≤—Ç–æ—Ä–∏', '–µ—â–µ —Ä–∞–∑', '—Ç–æ –∂–µ', '—Ç–æ—Ç –∂–µ', '–ø—Ä–µ–¥—ã–¥—É—â–∏–π', '–µ–≥–æ –∂–µ'];
        const isRepeatRequest = repeatKeywords.some(kw => lower.includes(kw));
        
        if (isRepeatRequest && lastYouTubeUrl) {
          playVideo(lastYouTubeUrl);
          addMessage(`–ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—é –≤–∏–¥–µ–æ –ø—Ä–æ "${lastYouTubeQuery}"`);
          return;
        }
        
        if (text.length < 3) {
          addMessage('–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–æ–µ –≤–∏–¥–µ–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å.');
          return;
        }
        
        addMessage(`–ò—â—É –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${text}"...`);
        const yt = await searchYouTube(text);
        if (yt) {
          lastYouTubeUrl = yt;
          lastYouTubeQuery = text;
          if (playVideo(yt)) {
            addMessage(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è: "${text}"`);
          } else {
            addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" –¥–ª—è –∑–∞–ø—É—Å–∫–∞.');
          }
        } else {
          addMessage('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –≤–∏–¥–µ–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.');
        }
        return;
      }

      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ YouTube - –ù–ï –∏—â–µ–º –≤–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      const aiPrompt = lastYouTubeQuery 
        ? `${text} (–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–µ–ª –≤–∏–¥–µ–æ –ø—Ä–æ "${lastYouTubeQuery}")` 
        : text;
      
      const ai = await getGeminiResponse(aiPrompt);
      hideThinking(); 
      addMessage(ai); 
      chatHistory.push({role: 'assistant', content: ai});
    }
	
	/* --- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ --- */
    function setupSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        addMessage('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏', false, true);
        voiceBtn.disabled = true; 
        return null;
      }
      
      const useSimpleMode = localStorage.getItem('simple_voice_mode') === 'true';
      
      const rec = new webkitSpeechRecognition();
      rec.continuous = true; // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º continuous —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–ª–Ω—ã—Ö —Ñ—Ä–∞–∑
      rec.interimResults = true; // –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
      rec.lang = 'ru-RU';
      rec.maxAlternatives = 3;
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
      rec._isRunning = false;
      rec._manualStop = false;
      rec._tempStop = false;
      rec._wasStarted = false;
      rec._completeCommand = ''; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
      rec._intermediateTexts = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      rec._processingTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã
      
      function updateVisualStatus(isRunning) {
        listeningIndicator.style.display = isRunning ? 'block' : 'none';
        voiceBtn.classList.toggle('active', isRunning);
        voiceBtn.textContent = isRunning ? 'üé§ –ê–∫—Ç–∏–≤–µ–Ω' : 'üé§';
        updateRecognitionStatus(isRunning ? '–°–ª—É—à–∞—é...' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
      }

      rec.onstart = () => {
        rec._isRunning = true;
        updateVisualStatus(true);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        rec._completeCommand = '';
        rec._intermediateTexts = [];
        
        if (volumeMeter) {
          volumeMeter.style.display = 'block';
          volumeLevel.style.width = '0%';
        }
        
        activateSpeechSynthesis();
        setupVolumeMeter();
        
        if (!rec._wasStarted) {
          addMessage('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∑–∞–ø—É—â–µ–Ω–æ. –Ø –≤–∞—Å —Å–ª—É—à–∞—é.'); 
          rec._wasStarted = true;
        }
        
        if (restartRecognitionTimer) {
          clearTimeout(restartRecognitionTimer);
          restartRecognitionTimer = null;
        }
      };
      
      rec.onend = () => {
        rec._isRunning = false;
        updateVisualStatus(false);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        if (volumeMeter) {
          volumeMeter.style.display = 'none';
        }
        
        console.log("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", 
                  "manual:", rec._manualStop, 
                  "temp:", rec._tempStop,
                  "speaking:", isSpeaking);
        
        // –ù–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        if (!rec._manualStop && !isSpeaking) {
          // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
          const delay = isSpeaking ? 1000 : 600;
          
          restartRecognitionTimer = setTimeout(() => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–ø—É—â–µ–Ω –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è
            if (!rec._isRunning && !rec._manualStop && !isSpeaking) {
              console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞");
              try {
                rec.start();
              } catch(err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ:', err);
                
                // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                setTimeout(() => {
                  try { 
                    console.log("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞");
                    rec.start(); 
                  } catch(err2) { 
                    console.error("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞:", err2);
                    updateRecognitionStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
                  }
                }, 1000);
              }
            }
          }, delay);
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        rec._tempStop = false;
      };

      rec.onerror = (event) => {
        console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏:", event.error);
        
        // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ç–æ–ª—å–∫–æ –æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
          addMessage('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', false, true);
          updateRecognitionStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        } else if (event.error === 'no-speech') {
          updateRecognitionStatus('–ù–µ —Å–ª—ã—à—É —Ä–µ—á–∏');
        } else if (event.error === 'audio-capture') {
          updateRecognitionStatus('–ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø–∏—Å—å—é –∑–≤—É–∫–∞');
        } else if (event.error === 'network') {
          updateRecognitionStatus('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
        } else {
          updateRecognitionStatus('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
        if (event.error === 'no-speech' || event.error === 'audio-capture' || event.error === 'network') {
          if (rec._isRunning) {
            rec.stop();
          } else if (!isSpeaking) {
            setTimeout(() => {
              try {
                rec.start();
              } catch(e) {
                console.error(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ ${event.error}:`, e);
              }
            }, 500);
          }
        }
      };

      // –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
      rec.onresult = async (event) => {
        if (isSpeaking) return;
        
        const result = event.results[event.results.length - 1];
        
        // –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        let bestText = '';
        let highestConfidence = 0;
        
        for (let i = 0; i < result.length; i++) {
          if (result[i].confidence > highestConfidence) {
            highestConfidence = result[i].confidence;
            bestText = result[i].transcript.trim();
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        if (bestText.length > 0) {
          updateRecognitionStatus('–°–ª—ã—à—É: ' + bestText);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –Ω–µ—Ç
        if (result.isFinal) {
          clearTimeout(rec._processingTimeout);
          
          // –í–ê–ñ–ù–û! –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
          rec._completeCommand = bestText;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∫–æ–º–∞–Ω–¥—ã –∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ YouTube –∑–∞–ø—Ä–æ—Å–∞
          const lower = bestText.toLowerCase();
          const isYoutubeRequest = lower.includes('–≤–∏–¥–µ–æ') || 
                               lower.includes('—é—Ç—É–±') || 
                               lower.includes('youtube') ||
                               lower.includes('—Ñ–∏–ª—å–º') ||
                               lower.includes('—Ä–æ–ª–∏–∫');
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
          rec._processingTimeout = setTimeout(() => {
            if (!processingMessage) {
              processingMessage = true;
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –∫–æ–º–∞–Ω–¥—É
              const finalCommand = rec._completeCommand;
              
              // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
              rec._completeCommand = '';
              rec._intermediateTexts = [];
              
              addMessage(finalCommand, true);
              showThinking();
              
              // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
              if (rec._isRunning) {
                rec._tempStop = true;
                rec.stop();
              }
              
              processCommand(finalCommand).finally(() => {
                processingMessage = false;
              });
            }
          }, isYoutubeRequest ? 800 : 300); // –î–ª—è YouTube –∑–∞–ø—Ä–æ—Å–æ–≤ –∂–¥–µ–º –¥–æ–ª—å—à–µ
          
        } else {
          // –î–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç
          if (bestText.length > 5) {
            rec._intermediateTexts.push(bestText);
            
            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –¥–ª–∏–Ω–Ω—ã–π, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é –∫–æ–º–∞–Ω–¥—É
            if (highestConfidence > 0.6 && bestText.length > 10) {
              rec._completeCommand = bestText;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            clearTimeout(rec._processingTimeout);
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞–ª –ø–∞—É–∑—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
            rec._processingTimeout = setTimeout(() => {
              if (!processingMessage && rec._completeCommand) {
                processingMessage = true;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É
                let bestCommand = rec._completeCommand;
                if (rec._intermediateTexts.length > 0) {
                  const longestText = rec._intermediateTexts.reduce((a, b) => 
                    a.length > b.length ? a : b, '');
                  if (longestText.length > bestCommand.length) {
                    bestCommand = longestText;
                  }
                }
                
                // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                rec._completeCommand = '';
                rec._intermediateTexts = [];
                
                addMessage(bestCommand, true);
                showThinking();
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                if (rec._isRunning) {
                  rec._tempStop = true;
                  rec.stop();
                }
                
                processCommand(bestCommand).finally(() => {
                  processingMessage = false;
                });
              }
            }, 1500); // –ë–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
          }
        }
      };
      
      return rec;
    }
	
	/* --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ --- */
    function setupVolumeMeter() {
      if (audioContext) return; // –ò–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      
      try {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
              audioStream = stream;
              audioContext = new (window.AudioContext || window.webkitAudioContext)();
              analyser = audioContext.createAnalyser();
              microphone = audioContext.createMediaStreamSource(stream);
              
              analyser.smoothingTimeConstant = 0.8;
              analyser.fftSize = 1024;
              
              microphone.connect(analyser);
              
              // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
              const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
              analyser.connect(scriptProcessor);
              scriptProcessor.connect(audioContext.destination);
              
              scriptProcessor.onaudioprocess = () => {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                const values = array.reduce((a, b) => a + b, 0) / array.length;
                
                if (volumeLevel) {
                  volumeLevel.style.width = Math.min(values * 2, 100) + '%';
                }
              };
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏:', err);
            });
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏:', e);
      }
    }

    // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∞—É–¥–∏–æ
    function cleanupAudioResources() {
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      if (audioContext) {
        audioContext.close().catch(e => console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:', e));
        audioContext = null;
      }
      analyser = null;
      microphone = null;
    }

    /* --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º --- */
    function toggleVoiceInput() {
      if (!recognition) {
        recognition = setupSpeechRecognition();
        if (!recognition) return;
      }
      
      if (recognition._isRunning) {
        recognition._manualStop = true;
        recognition.stop();
        addMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
      } else {
        try {
          // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
          activateSpeechSynthesis();
          
          // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤ –∏ –∑–∞–ø—É—Å–∫
          recognition._manualStop = false;
          recognition.start();
          
          addMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
        } catch(e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:", e);
          addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω', false, true);
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    function addRestartMicButton() {
      if (document.getElementById('restart-mic-btn')) return;
      
      const restartBtn = document.createElement('button');
      restartBtn.id = 'restart-mic-btn';
      restartBtn.textContent = 'üîÑ Mic';
      restartBtn.style.marginLeft = '5px';
      
      restartBtn.addEventListener('click', () => {
        // –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        if (recognition) {
          if (recognition._isRunning) {
            recognition.stop();
          }
          recognition = null;
        }
        
        // –û—á–∏—â–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –∞—É–¥–∏–æ
        cleanupAudioResources();
        
        setTimeout(() => {
          recognition = setupSpeechRecognition();
          if (recognition) {
            try {
              recognition.start();
              addMessage('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ');
            } catch(e) {
              console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:', e);
              addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω', false, true);
            }
          }
        }, 500);
      });
      
      document.getElementById('input-container').appendChild(restartBtn);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    function addVoiceConfigButton() {
      if (document.getElementById('voice-config-btn')) return;
      
      const configBtn = document.createElement('button');
      configBtn.id = 'voice-config-btn';
      configBtn.textContent = '‚öôÔ∏è';
      configBtn.style.marginLeft = '5px';
      
      configBtn.addEventListener('click', () => {
        const useSimpleMode = confirm('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏? (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)');
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        if (recognition) {
          if (recognition._isRunning) {
            recognition.stop();
          }
          recognition = null;
        }
        
        // –û—á–∏—â–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –∞—É–¥–∏–æ
        cleanupAudioResources();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
        setTimeout(() => {
          localStorage.setItem('simple_voice_mode', useSimpleMode ? 'true' : 'false');
          
          if (useSimpleMode) {
            addMessage('–í–∫–ª—é—á–µ–Ω —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –ì–æ–≤–æ—Ä–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ —Å –ø–∞—É–∑–∞–º–∏.');
          } else {
            addMessage('–í–∫–ª—é—á–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.');
          }
          
          recognition = setupSpeechRecognition();
          if (recognition) {
            try {
              recognition.start();
            } catch(e) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞:', e);
            }
          }
        }, 500);
      });
      
      document.getElementById('input-container').appendChild(configBtn);
    }
	
	/* --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π --- */
    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥
    sendBtn.addEventListener('click', () => {
      activateSpeechSynthesis();
      sendMessage();
    });
    
    userInput.addEventListener('keydown', e => { 
      if (e.key === 'Enter') {
        activateSpeechSynthesis();
        sendMessage();
      }
    });
    
    // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
    voiceBtn.addEventListener('click', () => {
      activateSpeechSynthesis();
      toggleVoiceInput();
    });
    
    // –ö–∞–º–µ—Ä–∞
    cameraBtn.addEventListener('click', capturePhoto);
    
    // YouTube
    youtubePlayBtn.addEventListener('click', () => {
      if (youtubePlayerState === 'paused') {
        continueYouTubeVideo();
        addMessage('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–æ');
      } else {
        playCurrentYouTube();
      }
    });
    
    youtubeSearchBtn.addEventListener('click', initiateNewYouTubeSearch);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø—É–ª—å—Ç–∞ –¥–ª—è Android TV
    document.addEventListener('keydown', (e) => {
      switch(e.keyCode) {
        case 13: // OK button
          if (document.activeElement === userInput) {
            sendMessage();
          } else {
            toggleVoiceInput();
          }
          break;
        case 37: // Left
          userInput.focus();
          break;
        case 39: // Right
          voiceBtn.focus();
          break;
        case 27: // Back
          stopSpeech();
          stopCamera();
          stopRecording();
          if (recognition && recognition._isRunning) {
            recognition._manualStop = true;
            recognition.stop();
          }
          break;
      }
    });

    /* --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è --- */
    function init() {
      // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Android TV
      if (isAndroidTV) {
        initForTV();
      }
      
      // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤
      if ('speechSynthesis' in window) {
        window.speechSynthesis.getVoices();
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      addRestartMicButton();
      addVoiceConfigButton();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
      const savedMode = localStorage.getItem('simple_voice_mode');
      if (savedMode === 'true') {
        updateRecognitionStatus('–†–µ–∂–∏–º: —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ');
      } else {
        updateRecognitionStatus('–†–µ–∂–∏–º: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ');
      }
      
      // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      setTimeout(() => {
        addMessage('–ü—Ä–∏–≤–µ—Ç! –Ø KiKo Beam - –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è? üòä');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
          if (!recognition) {
            recognition = setupSpeechRecognition();
          }
          
          if (recognition && !recognition._isRunning) {
            try {
              recognition.start();
            } catch(e) {
              console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", e);
              setTimeout(() => {
                try { 
                  recognition.start(); 
                } catch(e) { 
                  console.error("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:", e);
                  addMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É üé§, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é.");
                }
              }, 1000);
            }
          }
        }, 1000);
      }, 500);
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
		
		
