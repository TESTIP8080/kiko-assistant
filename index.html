<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- 
    –í–ê–ñ–ù–û: –≠—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞. 
    –ù–∞ GitHub Pages —ç—Ç–∏ meta-—Ç–µ–≥–∏ –∏–º–µ—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–æ–≤—Å–µ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤.
    HTTPS –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è GitHub Pages –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
  -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta http-equiv="Permissions-Policy" content="microphone=*, camera=*">
  <!-- –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (Access-Control) –ù–ï –†–ê–ë–û–¢–ê–Æ–¢ –∫–∞–∫ <meta> —Ç–µ–≥–∏. 
       –û–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤. -->
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta http-equiv="Access-Control-Allow-Methods" content="GET, POST, OPTIONS">
  <meta http-equiv="Access-Control-Allow-Headers" content="Content-Type, Authorization">
  <title>KiKo - Intelligent Chat Assistant</title>
  <style>
    :root {
      --bg-primary: #1e1e1e;
      --text-primary: #ffffff;
      --accent-color: #bb86fc;
      --secondary-color: #03dac6;
      --panel-bg: #2c2c2c;
      --border-radius: 10px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .app-container {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
      gap: 10px;
      padding: 10px;
    }
    .chat-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      position: relative;
      overflow: hidden;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: rgba(255,255,255,0.05);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .message {
      max-width: 80%;
      margin: 6px 0;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .user-message {
      background-color: var(--accent-color);
      align-self: flex-end;
      margin-left: auto;
      color: #000;
    }
    .ai-message {
      background-color: rgba(255,255,255,0.1);
      align-self: flex-start;
    }
    .error-message {
      color: #ff4b4b;
      background-color: rgba(255,0,0,0.2);
    }
    .thinking-message {
      font-style: italic;
      opacity: 0.8;
    }
    #input-container {
      display: flex;
      gap: 10px;
    }
    #user-input {
      flex-grow: 1;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-primary);
      border-radius: 5px;
    }
    #send-btn, #voice-btn {
      background-color: var(--secondary-color);
      color: var(--bg-primary);
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    #voice-btn.active {
      background-color: red;
      color: white;
    }
    #listening-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: red;
      animation: pulse 1.5s infinite;
      position: absolute;
      top: 15px;
      right: 15px;
      display: none;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
    .media-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .media-container {
      background-color: var(--panel-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .media-container h4 {
      margin-bottom: 10px;
    }
    #camera-area, #video-area {
      flex: 1;
      display: none;
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
      background-color: #000;
    }
    #camera-area.active {
      display: flex;
    }
    #video-area.active {
      display: flex;
    }
    #camera-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #camera-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    #video-area iframe {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: var(--border-radius);
      border: none;
      /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∞—Ç—Ä–∏–±—É—Ç–∞ allow - –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é */
      allow="autoplay, encrypted-media";
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è Android TV */
     /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è focus, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø—É–ª—å—Ç–∞ */
    [tabindex="0"]:focus, button:focus, input:focus {
        outline: 3px solid var(--accent-color);
    }
    @media (hover: none) {
      #send-btn, #voice-btn {
        padding: 15px 30px;
        font-size: 1.2em;
        transition: none;
      }
      /* –£–±—Ä–∞–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è scale(1.1) –¥–ª—è focus –Ω–∞ –¢–í, —Ç.–∫. –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—É–¥–æ–±–Ω–æ–π */
      /*
      #send-btn:focus, #voice-btn:focus {
        outline: 3px solid var(--accent-color);
        transform: scale(1.1);
      }
      #user-input:focus {
        outline: 3px solid var(--accent-color);
      }
      */
       /* –£–±–∏—Ä–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã, —Ç–∞–∫ –∫–∞–∫ –Ω–∞ –¢–í –∏—Ö –Ω–µ—Ç */
      button:hover {
         transform: none !important;
         opacity: 1 !important;
      }
    }
  </style>
  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ HTTPS (–µ—Å–ª–∏ –Ω–µ localhost, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º)
    // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ–º–µ–Ω GitHub Pages, —Ç.–∫. –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTPS
    const isGithubPages = window.location.hostname.endsWith('.github.io');
    if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost') && !isGithubPages) {
      window.location.href = window.location.href.replace('http:', 'https:');
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Android TV (—É–ª—É—á—à–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
    const userAgent = navigator.userAgent.toLowerCase();
    const isAndroidTV = userAgent.includes('android tv') || userAgent.includes('smarttv') || (userAgent.includes('android') && !userAgent.includes('mobile'));
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Android TV
    function initForTV() {
      console.log("Initializing for Android TV...");
      // document.documentElement.style.fontSize = '24px'; // –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å font-size –∑–¥–µ—Å—å, –µ—Å–ª–∏ —Å—Ç–∏–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ
      // –£–¥–∞–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π style tag, focus —Å—Ç–∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–±—â—É—é —Å–µ–∫—Ü–∏—é style
      
      // –î–æ–±–∞–≤–ª—è–µ–º tabindex –∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –ø—É–ª—å—Ç–∞
      document.querySelectorAll('button, input[type="text"]').forEach(el => {
        el.setAttribute('tabindex', '0');
      });
       // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–æ–∫—É—Å –≤–∏–¥–µ–Ω (—Å—Ç–∏–ª–∏ focus –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—ã—à–µ –≤ —Å–µ–∫—Ü–∏–∏ style)
    }
  </script>
</head>
<body>
  <div class="app-container">
    <!-- –ß–∞—Ç -->
    <div class="chat-panel">
      <div id="listening-indicator"></div>
      <div id="chat-container"></div>
      <div id="input-container">
        <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."/>
        <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="voice-btn">üé§</button>
      </div>
    </div>
    <!-- –ö–∞–º–µ—Ä–∞ –∏ YouTube -->
    <div class="media-panel">
      <div class="media-container">
        <h4>–ö–∞–º–µ—Ä–∞</h4>
        <div id="camera-area">
          <video id="camera-preview" autoplay muted></video>
          <button id="camera-btn">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
      </div>
      <div class="media-container">
        <h4>YouTube</h4>
        <div id="video-area">
          <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∞—Ç—Ä–∏–±—É—Ç–∞ allow -->
          <iframe allow="autoplay, encrypted-media"></iframe>
        </div>
      </div>
    </div>
  </div>
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Global error:', {message, source, lineno, colno, error});
      addMessage(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${message}`, false, true);
      return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —Ç–∞–∫–∂–µ –≤—ã–≤–µ–ª –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
    };

    // ===========================
    //     –í–∞—à–∏ API –∫–ª—é—á–∏
    // ===========================
    // –í–ê–ñ–ù–û: –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ –ö–†–ê–ô–ù–ï –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û!
    // –ù–∞ GitHub Pages —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –±—ç–∫–µ–Ω–¥–∞, –ù–û
    // –ù–ï–û–ë–•–û–î–ò–ú–û –î–û–ë–ê–í–ò–¢–¨ –°–¢–†–û–ì–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ü–û HTTP-–†–ï–§–ï–†–ï–†–£ –í GOOGLE CLOUD CONSOLE
    // (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –¥–ª—è https://–≤–∞—à–µ–∏–º—è–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.github.io/–∏–º—è—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è/*)
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ó–ê–ì–õ–£–®–ö–ò API –∫–ª—é—á–µ–π –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–æ–∂–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!
    // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ê–ì–õ–£–®–ö–ò –ù–ê –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –ö–õ–Æ–ß–ò (Gemini –ò YouTube)!
    const config = {
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ. 
      // –í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–∞/github.io.
      // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ '–í–ê–®_API_–ö–õ–Æ–ß_GEMINI' - —ç—Ç–æ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á Gemini.
      GEMINI_API_KEY: (location.hostname === 'localhost' || isGithubPages)
          ? 'AIzaSyB0nsn5A_a6nAtGQsIZ-RZGrotGoCJaF8A' // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–ª—é—á Gemini!
          : '', // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –Ω–∞ –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–∞—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ.
      // –í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–∞/github.io.
      // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ '–í–ê–®_API_–ö–õ–Æ–ß_YOUTUBE' - —ç—Ç–æ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á YouTube Data API.
      YOUTUBE_API_KEY: (location.hostname === 'localhost' || isGithubPages)
          ? 'AIzaSyDt1cRmHyYNEPnu78Wt4Y_RgXNhKwD2Q44' // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∫–ª—é—á YouTube Data API!
          : '' // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –Ω–∞ –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–∞—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    };
     // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–ª—é—á–∏ –∑–∞–º–µ–Ω–µ–Ω—ã (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã)
     if (config.GEMINI_API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß_GEMINI' || config.YOUTUBE_API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß_YOUTUBE') {
        console.warn("–í–ù–ò–ú–ê–ù–ò–ï: API –∫–ª—é—á–∏ –Ω–µ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª AI –∏ YouTube –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ó–∞–º–µ–Ω–∏—Ç–µ –ó–ê–ì–õ–£–®–ö–ò –≤ –∫–æ–¥–µ –Ω–∞ –≤–∞—à–∏ –∫–ª—é—á–∏.");
     }

     // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è API –∫–ª—é—á–∞ OpenAI –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —É–¥–∞–ª–µ–Ω–∞, —Ç.–∫. –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Gemini.
     // const OPENAI_API_KEY = '...'; 


    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–¥–ª—è Gemini)
    let chatHistory = [];
 
     // ===========================
     //   DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
     // ===========================
     const chatContainer = document.getElementById('chat-container');
     const userInput = document.getElementById('user-input');
     const sendBtn = document.getElementById('send-btn');
     const voiceBtn = document.getElementById('voice-btn');
     const listeningIndicator = document.getElementById('listening-indicator');
     const cameraArea = document.getElementById('camera-area');
     const cameraPreview = document.getElementById('camera-preview');
     const cameraBtn = document.getElementById('camera-btn');
     const videoArea = document.getElementById('video-area');
     const videoIframe = videoArea.querySelector('iframe');
 
     let recognition = null;
     let currentSpeechSynthesis = null;
     let lastRecognizedText = ''; // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ onresult
     let processingMessage = false; // –§–ª–∞–≥, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
     let cameraStream = null;
     let isCameraActive = false;
     let mediaRecorder = null; // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
     let recordedChunks = []; // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
     let isRecording = false; // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
     let lastPhotoDataUrl = null;
     let lastVideoBlobUrl = null; // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
     let lastYouTubeUrl = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–¥–µ–æ
     let thinkingMessageDiv = null; // –î–ª—è ¬´–î—É–º–∞—é...¬ª
     let isSpeaking = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –≥–æ–≤–æ—Ä–∏—Ç –ª–∏ —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
     let speechActivated = false; // –§–ª–∞–≥, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (–ø–µ—Ä–≤—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º)
     let noSpeechTimer = null; // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ onresult
     let retryCount = 0; // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ Gemini
     const MAX_RETRIES = 3;
 
     // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ (—É–¥–∞–ª—è–µ—Ç —Å–∏–º–≤–æ–ª—ã —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–∏—Å—å –≥–æ–ª–æ—Å–æ–º)
     function stripEmojis(text) {
       return text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/gu, '');
     }
 
     // ===========================
     //   –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á–∞—Ç–∞ –∏ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
     // ===========================
     function addMessage(text, isUser = false, isError = false) {
       const messageDiv = document.createElement('div');
       messageDiv.classList.add('message');
       if (isError) {
         messageDiv.classList.add('error-message');
       } else {
         messageDiv.classList.add(isUser ? 'user-message' : 'ai-message');
       }
       messageDiv.textContent = text;
       chatContainer.appendChild(messageDiv);
       chatContainer.scrollTop = chatContainer.scrollHeight;
       // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ò —Å–∏–Ω—Ç–µ–∑ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –æ–∑–≤—É—á–∏–≤–∞–µ–º –µ–≥–æ –±–µ–∑ —ç–º–æ–¥–∑–∏.
       // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ speechActivated –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
       if (!isUser && !isError && speechActivated) {
         speakResponse(text);
       }
       return messageDiv; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∫–∞–∫ –¥–ª—è —Ñ–æ—Ç–æ)
     }
 
     function showThinking() {
       hideThinking(); // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
       thinkingMessageDiv = document.createElement('div');
       // –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª–∞—Å—Å—ã –¥–ª—è —Å—Ç–∏–ª–µ–π ai-message
       thinkingMessageDiv.classList.add('message', 'ai-message', 'thinking-message');
       thinkingMessageDiv.textContent = '–î—É–º–∞—é...ü§î'; // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏
       chatContainer.appendChild(thinkingMessageDiv);
       chatContainer.scrollTop = chatContainer.scrollHeight;
     }
 
     function hideThinking() {
       if (thinkingMessageDiv && thinkingMessageDiv.parentNode) {
         thinkingMessageDiv.parentNode.removeChild(thinkingMessageDiv);
       }
       thinkingMessageDiv = null;
     }
 
     function stopSpeech() {
       if (currentSpeechSynthesis && window.speechSynthesis.speaking) {
         console.log('Stopping speech synthesis...');
         window.speechSynthesis.cancel();
       }
        isSpeaking = false; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
        currentSpeechSynthesis = null;
     }
 
     // –ì–æ–ª–æ—Å–æ–≤–æ–π —Å–∏–Ω—Ç–µ–∑: —É–¥–∞–ª—è–µ—Ç —ç–º–æ–¥–∑–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 1.5
     function speakResponse(text) {
       hideThinking(); // –£–±–∏—Ä–∞–µ–º ¬´–î—É–º–∞—é...¬ª, –µ—Å–ª–∏ –±—ã–ª–æ
       stopSpeech(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
       if (!('speechSynthesis' in window) || !speechActivated) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—é
            if (!speechActivated) console.warn("Speech synthesis not yet activated.");
           return;
       }
       try {
         const cleanText = stripEmojis(text);
         const utterance = new SpeechSynthesisUtterance(cleanText);
         utterance.lang = 'ru-RU';
         utterance.rate = 1.5; // –°–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
         utterance.pitch = 1.0; // –í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞
         utterance.volume = 1.0; // –ì—Ä–æ–º–∫–æ—Å—Ç—å

         const voices = window.speechSynthesis.getVoices();
         const ruVoice = voices.find(voice => voice.lang.startsWith('ru-RU') || voice.lang.startsWith('ru_'));
         if (ruVoice) {
           utterance.voice = ruVoice;
         } else {
             console.warn("Russian voice not found, using default.");
             // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ –≥–æ–ª–æ—Å, –µ—Å–ª–∏ —Ä—É—Å—Å–∫–æ–≥–æ –Ω–µ—Ç
             if (voices.length > 0) {
                  utterance.voice = voices[0]; // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –≥–æ–ª–æ—Å
             }
         }

         isSpeaking = true;
         utterance.onend = () => { 
            console.log('Speech synthesis ended.');
            isSpeaking = false;
            currentSpeechSynthesis = null; 
         };
          utterance.onerror = (event) => {
             console.error('Speech synthesis error:', event.error);
             isSpeaking = false;
             currentSpeechSynthesis = null;
         };

         currentSpeechSynthesis = utterance; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π utterance
         window.speechSynthesis.speak(utterance);

       } catch (error) {
         console.error('Speech synthesis error:', error);
         isSpeaking = false;
       }
        // –ß—Ç–æ–±—ã –≥–æ–ª–æ—Å–∞ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É, –Ω—É–∂–Ω–æ –∏—Ö –∑–∞–≥—Ä—É–∑–∏—Ç—å.
        // –≠—Ç–æ —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏.
        // –°–æ–±—ã—Ç–∏–µ voiceschanged –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ.
        const voicesCheck = window.speechSynthesis.getVoices();
        if (!voicesCheck || voicesCheck.length === 0) {
            window.speechSynthesis.onvoiceschanged = () => {
                console.log("Speech synthesis voices changed/loaded. Trying to speak again.");
                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
                if (text) speakResponse(text);
                // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ç–ª—é
                window.speechSynthesis.onvoiceschanged = null; 
            };
        }
     }

     // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
     function activateSpeechSynthesis() {
       if (speechActivated) return;
       if ('speechSynthesis' in window) {
          console.log("Activating speech synthesis...");
         // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
         const voices = window.speechSynthesis.getVoices(); // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ —Å–∞–º–∞ –ø–æ —Å–µ–±–µ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
         
         // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ —Ç–∏—Ö–∏–π –∑–≤—É–∫ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ iOS –∏ –¥—Ä.
         try {
             const silence = new SpeechSynthesisUtterance('.');
             silence.volume = 0;
             silence.rate = 0.1; // –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –±—ã–ª —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ –∑–≤—É–∫
             silence.lang = 'en-US'; // –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –≥–æ–ª–æ—Å –¥–ª—è —Ç–∏—à–∏–Ω—ã
             window.speechSynthesis.speak(silence);
             console.log("Attempted silent speech activation.");
         } catch(e) {
             console.warn("Silent speech activation failed:", e);
         }

         speechActivated = true;
         console.log("Speech synthesis activated.");

         // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
         document.body.removeEventListener('click', activateSpeechSynthesis, { once: true });
         document.body.removeEventListener('keydown', activateSpeechSynthesis, { once: true });
         document.body.removeEventListener('touchstart', activateSpeechSynthesis, { once: true });
         document.body.removeEventListener('focus', activateSpeechSynthesis, { once: true });
       } else {
            console.warn("Speech synthesis not supported, cannot activate.");
       }
     }


     // ===========================
     //   –†–∞–±–æ—Ç–∞ —Å –∫–∞–º–µ—Ä–æ–π
     // ===========================
     async function startCamera() {
       if (isCameraActive) {
         addMessage('–ö–∞–º–µ—Ä–∞ —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞. –°–∫–∞–∂–∏—Ç–µ "—Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ" –∏–ª–∏ "–≤—ã–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É".');
         return;
       }
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
           addMessage('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º (–∫–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω).', false, true);
           console.error('getUserMedia not supported in this browser');
           return;
        }
       try {
         console.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...');
         // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Å–æ –∑–≤—É–∫–æ–º, –¥–æ–±–∞–≤—å—Ç–µ audio: true.
         cameraStream = await navigator.mediaDevices.getUserMedia({
           video: { width: { ideal: 1280 }, height: { ideal: 720 } },
           audio: false // –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞—É–¥–∏–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
         });
          console.log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω.');
         cameraPreview.srcObject = cameraStream;
         cameraArea.classList.add('active');
         isCameraActive = true;
         addMessage('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. –°–∫–∞–∂–∏—Ç–µ "—Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ", —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫.');
       } catch (error) {
         console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
         let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.';
          if (error.name === 'NotFoundError') {
              errorMessage += ' –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
          } else if (error.name === 'SecurityError') {
              errorMessage += ' –¢—Ä–µ–±—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (HTTPS).'; // –ù–∞ GitHub Pages —ç—Ç–æ –µ—Å—Ç—å
          } else if (error.name === 'PermissionDeniedError') {
               errorMessage += ' –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.';
          } else {
              errorMessage += ` –û—à–∏–±–∫–∞: ${error.name}`;
          }
         addMessage(errorMessage, false, true);
       }
     }
 
     function stopCamera() {
       if (cameraStream) {
         console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã...');
         cameraStream.getTracks().forEach(track => track.stop());
         cameraPreview.srcObject = null;
         cameraStream = null;
       }
       cameraArea.classList.remove('active');
       isCameraActive = false;
       addMessage('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞.');
     }
 
     function capturePhoto() {
       if (!cameraStream || !isCameraActive) {
         addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–µ –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ. –°–∫–∞–∂–∏—Ç–µ "–≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É".', false, true);
         return;
       }
        if (processingMessage) {
            addMessage('–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å.', false, true);
            return;
        }
       // processingMessage = true; // –§–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ sendMessage/processCommand
        hideThinking(); // –°–∫—Ä—ã–≤–∞–µ–º "–î—É–º–∞—é..." –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
       try {
         console.log('–î–µ–ª–∞–µ–º —Ñ–æ—Ç–æ...');
         const canvas = document.createElement('canvas');
         canvas.width = cameraPreview.videoWidth;
         canvas.height = cameraPreview.videoHeight;
         const ctx = canvas.getContext('2d');
         ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
         const photoDataUrl = canvas.toDataURL('image/jpeg', 0.9); // –ö–∞—á–µ—Å—Ç–≤–æ 0.9
         lastPhotoDataUrl = photoDataUrl;
         const imgElement = document.createElement('img');
         imgElement.src = photoDataUrl;
         imgElement.style.maxWidth = '100%';
         imgElement.style.maxHeight = '200px';
          imgElement.style.display = 'block'; // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
          imgElement.style.marginTop = '10px'; // –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É

         const downloadBtn = document.createElement('button');
         downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ üì∏';
         downloadBtn.style.marginLeft = '10px';
          downloadBtn.style.marginTop = '10px';
          downloadBtn.style.padding = '5px 10px';
          downloadBtn.style.backgroundColor = '#007bff'; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
          downloadBtn.style.color = 'white';
          downloadBtn.style.border = 'none';
          downloadBtn.style.borderRadius = '5px';
          downloadBtn.style.cursor = 'pointer';

         downloadBtn.onclick = () => {
           if (!lastPhotoDataUrl) {
             addMessage('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ', false, true);
             return;
           }
           const a = document.createElement('a');
           a.href = lastPhotoDataUrl;
           a.download = 'kiko_photo.jpg'; // –ò–º—è —Ñ–∞–π–ª–∞
            document.body.appendChild(a); // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ DOM –¥–ª—è Firefox
           a.click();
           document.body.removeChild(a); // –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
         };
         const msg = addMessage('–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ:');
         msg.appendChild(imgElement);
         msg.appendChild(downloadBtn);
          console.log('–§–æ—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç.');

       } catch (error) {
         console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–æ—Ç–æ:', error);
         addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ.', false, true);
       } finally {
         // processingMessage = false; // –§–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ sendMessage/processCommand
         // –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ capturePhoto –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ processCommand,
         // –ø–æ—ç—Ç–æ–º—É —Ñ–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ç–∞–º. –ï—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, –µ–≥–æ –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∑–¥–µ—Å—å.
       }
     }
 
     // –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ (—Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ processCommand –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
     function startRecording() {
       if (!cameraStream) {
         addMessage('–ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', false, true);
         return;
       }
        if (isRecording) {
           addMessage('–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —É–∂–µ –∏–¥–µ—Ç.', false, true);
           return;
        }
       // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ getUserMedia –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å audio: true, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å –∑–≤—É–∫–∞
       try {
           // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ cameraStream. –ï—Å–ª–∏ –Ω–µ—Ç, –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∞—É–¥–∏–æ –æ—Ç–¥–µ–ª—å–Ω–æ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —Å –∞—É–¥–∏–æ.
           const streamToRecord = (cameraStream && cameraStream.getAudioTracks().length > 0) ? cameraStream : null; // –ü—Ä–æ–≤–µ—Ä–∫–∞ cameraStream –Ω–∞ null

           if (!streamToRecord) {
                addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ç–æ–∫—É –∞—É–¥–∏–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ —Å –∞—É–¥–∏–æ –¥–æ—Å—Ç—É–ø–æ–º.', false, true);
                console.error('Audio track not available in camera stream for recording.');
                return;
           }
         mediaRecorder = new MediaRecorder(streamToRecord);
         recordedChunks = [];
         mediaRecorder.ondataavailable = (event) => {
           if (event.data.size > 0) {
             recordedChunks.push(event.data);
           }
         };
         mediaRecorder.onstop = () => {
           // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø 'video/mp4', –Ω–æ –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, webm)
           // –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å event.data.type –≤ ondataavailable –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ç–∏–ø–∞
           const blobType = recordedChunks.length > 0 ? recordedChunks[0].type : 'video/mp4';
           const blob = new Blob(recordedChunks, { type: blobType });
           lastVideoBlobUrl = URL.createObjectURL(blob);
           const downloadBtn = document.createElement('button');
           downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ üé¨';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.padding = '5px 10px';
            downloadBtn.style.backgroundColor = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
            downloadBtn.style.color = 'white';
            downloadBtn.style.border = 'none';
            downloadBtn.style.borderRadius = '5px';
            downloadBtn.style.cursor = 'pointer';

           downloadBtn.onclick = () => {
             if (!lastVideoBlobUrl) {
               addMessage('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ', false, true);
               return;
             }
             const a = document.createElement('a');
             a.href = lastVideoBlobUrl;
             a.download = 'kiko_video.' + (blobType.split('/')[1] || 'mp4'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
             // –ú–æ–∂–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å URL –æ–±—ä–µ–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
             // URL.revokeObjectURL(lastVideoBlobUrl); lastVideoBlobUrl = null;
           };
           const msg = addMessage('–í–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ:');
           msg.appendChild(downloadBtn);
            recordedChunks = []; // –û—á–∏—â–∞–µ–º —á–∞–Ω–∫–∏
         };
          mediaRecorder.onerror = (event) => {
               console.error('MediaRecorder error:', event.error);
               addMessage(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ: ${event.error.name}`, false, true);
               isRecording = false;
               recordedChunks = [];
           };

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ mediaRecorder –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
          if (mediaRecorder.state === 'inactive') {
               mediaRecorder.start();
               isRecording = true;
               addMessage('–ù–∞—á–∞—Ç–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ üî¥');
               console.log('MediaRecorder started');
          } else {
              console.warn('MediaRecorder state is not inactive:', mediaRecorder.state);
              addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ. MediaRecorder –∑–∞–Ω—è—Ç.', false, true);
          }

       } catch (error) {
         console.error('Error starting MediaRecorder:', error);
          addMessage(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ: ${error.message}`, false, true);
       }
     }
 
     function stopRecording() {
       if (!mediaRecorder || !isRecording || mediaRecorder.state === 'inactive') { // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
         addMessage('–í–∏–¥–µ–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.', false, true);
         return;
       }
        if (mediaRecorder.state === 'recording') {
            console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ...');
            mediaRecorder.stop(); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç onstop
            isRecording = false;
            addMessage('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ.');
        } else {
             console.warn('MediaRecorder is not in recording state:', mediaRecorder.state);
             addMessage('–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.', false, true);
        }
     }
 
     // AI (Gemini) –∏ YouTube
     async function getGeminiResponse(text) {
       if (!config.GEMINI_API_KEY || config.GEMINI_API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß_GEMINI') {
         addMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API-–∫–ª—é—á Gemini –≤ –∫–æ–¥–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI.', false, true);
         return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API-–∫–ª—é—á Gemini';
       }
 
       try {
         // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Gemini
         const geminiHistory = chatHistory.map(msg => ({
           role: msg.role === 'user' ? 'user' : 'model', // Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 'model' –¥–ª—è —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏
           parts: [{ text: msg.content }]
         }));

         // –î–æ–±–∞–≤–∏–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä—Å–æ–Ω—ã
         const systemInstruction = {
           role: "model", // –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —á–∞—Å—Ç–æ —Ä–∞–±–æ—Ç–∞—é—Ç –ª—É—á—à–µ –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ Gemini 1.5 Pro
           parts: [{
             text: `–¢—ã –ö–∏–∫–æ ‚Äì –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä–æ–±–æ—Ç-–¥—Ä—É–≥ —Å–µ–º—å–∏.
 –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
 - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –≤–µ—Å–µ–ª—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏;
 - –ê–¥–∞–ø—Ç–∏—Ä—É–µ—à—å –æ–±—â–µ–Ω–∏–µ –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞;
 - –î–∞—ë—à—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–µ–º–µ–π–Ω–æ–π –∂–∏–∑–Ω–∏;
 - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç;
 - –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫;
 - –û—Ç–≤–µ—á–∞–π –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ (1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ; // –°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
 - –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏.
 –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ, –æ—Ç–≤–µ—á–∞–π —Ç–∞–∫: "–ö–æ–Ω–µ—á–Ω–æ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —ç—Ç–æ –≤–∏–¥–µ–æ, –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ YouTube —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –≤–∏–¥–µ–æ."
 –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π —É–º–µ—Å—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ (–Ω–æ –Ω–µ –æ–∑–≤—É—á–∏–≤–∞–π –∏—Ö) –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.`
           }]
         };

         // –î–æ–±–∞–≤–∏–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         const userRequest = {
           role: "user",
           parts: [{ text }]
         };
 
         const requestBody = {
           contents: [
             systemInstruction, // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
             ...geminiHistory, // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
             userRequest // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
           ],
           generationConfig: {
             temperature: 0.7, // –ù–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∑–∏–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥–ª—è –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
             topK: 40,
             topP: 0.95,
             maxOutputTokens: 500, // –£–º–µ–Ω—å—à–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
           },
           safetySettings: [
             {
               category: "HARM_CATEGORY_HARASSMENT",
               threshold: "BLOCK_MEDIUM_AND_ABOVE"
             },
             {
               category: "HARM_CATEGORY_HATE_SPEECH",
               threshold: "BLOCK_MEDIUM_AND_ABOVE"
             },
             {
               category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
               threshold: "BLOCK_MEDIUM_AND_ABOVE"
             },
             {
               category: "HARM_CATEGORY_DANGEROUS_CONTENT",
               threshold: "BLOCK_MEDIUM_AND_ABOVE"
             }
           ]
         };
 
         console.log("Sending request to Gemini:", requestBody);

         // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ API Gemini
         const response = await fetch(
           `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${config.GEMINI_API_KEY}`,
           {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json'
             },
             body: JSON.stringify(requestBody)
           }
         );
 
         if (!response.ok) {
           const errorData = await response.json();
           console.error('Gemini API Error Response:', response.status, errorData);
           // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
           const errorMessage = errorData && errorData.error && errorData.error.message ? errorData.error.message : `HTTP error! status: ${response.status}`;
           throw new Error(`Gemini API Error: ${errorMessage}`);
         }
 
         const data = await response.json();
         console.log("Gemini API Response:", data);
         
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
         if (data.candidates && data.candidates.length > 0 && 
             data.candidates[0].content && 
             data.candidates[0].content.parts && 
             data.candidates[0].content.parts.length > 0) {
           // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
           retryCount = 0;
           return data.candidates[0].content.parts[0].text;
         } else if (data.promptFeedback && data.promptFeedback.blockReason) {
           // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
           retryCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
           return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ —è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å. –ü—Ä–∏—á–∏–Ω–∞: ${data.promptFeedback.blockReason}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ! ü§î`;
         } else if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason && data.candidates[0].finishReason !== 'STOP') {
              // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏—á–∏–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –∫—Ä–æ–º–µ STOP (—É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
              retryCount = 0;
              return `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü—Ä–∏—á–∏–Ω–∞: ${data.candidates[0].finishReason}. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–µ–º–∞ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–∞—è –∏–ª–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è.`;
         }
         else {
           console.error('Unexpected Gemini response structure:', data);
           // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞
           if (retryCount < MAX_RETRIES) {
               retryCount++;
               console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${MAX_RETRIES} –ø–æ—Å–ª–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞...`);
               await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
               return await getGeminiResponse(text); // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
           }
           retryCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
           throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini API –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫.');
         }
       } catch (error) {
         console.error('Gemini Response Error Catch:', error);
 
         // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
         if (retryCount < MAX_RETRIES) {
           retryCount++;
           console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${MAX_RETRIES} –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏: ${error.message}`);
           await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
           return await getGeminiResponse(text); // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
         }
 
         // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
         retryCount = 0;
         return `–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ.`;
       }
     }
 
     async function searchYouTube(query) {
       if (!config.YOUTUBE_API_KEY || config.YOUTUBE_API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß_YOUTUBE') {
         console.warn("YouTube API key not configured.");
         addMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API-–∫–ª—é—á YouTube –≤ –∫–æ–¥–µ.', false, true);
         return null;
       }
        if (!query || query.trim() === '') {
            addMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏ –Ω–∞ YouTube.', false, true);
            return null;
        }

       try {
         console.log(`Searching YouTube for: "${query}"`);
         const response = await fetch(
           `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${config.YOUTUBE_API_KEY}`
         );
         const data = await response.json();
         console.log("YouTube Search Response:", data);

         if (!response.ok) {
             console.error('YouTube API Error:', response.status, data);
              // –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
             const errorMessage = data && data.error && data.error.message ? data.error.message : `HTTP error! status: ${response.status}`;
             addMessage(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞ YouTube: ${errorMessage}`, false, true);
             return null; // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É
         }

         if (data.items && data.items.length > 0) {
           console.log("YouTube video found:", data.items[0].id.videoId);
           return `https://www.youtube.com/watch?v=${data.items[0].id.videoId}`;
         }
          console.log("No YouTube results found for query:", query);
         return null;
       } catch (error) {
         console.error('YouTube Search Error Catch:', error);
          addMessage(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –Ω–∞ YouTube: ${error.message}`, false, true);
         return null;
       }
     }
 
     function playVideo(url) {
       if (!url) {
           addMessage('–ù–µ –º–æ–≥—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–∏–¥–µ–æ: URL –Ω–µ —É–∫–∞–∑–∞–Ω.', false, true);
           return;
       }
       // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL YouTube —Å—Å—ã–ª–∫–æ–π –Ω–∞ –≤–∏–¥–µ–æ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º ID
       const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?([a-zA-Z0-9_-]+)/;
       const match = url.match(youtubeRegex);

       if (!match || !match[1]) {
           addMessage('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ YouTube –≤–∏–¥–µ–æ.', false, true);
           return;
       }

       const videoId = match[1];
       // URL –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è iframe —Å –æ–ø—Ü–∏–µ–π autoplay
       const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`; // –î–æ–±–∞–≤–ª—è–µ–º enablejsapi –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è iframe —á–µ—Ä–µ–∑ JS
       lastYouTubeUrl = url; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π URL

       videoArea.classList.add('active'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ
       videoIframe.src = embedUrl; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –¥–ª—è iframe
       addMessage(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É –≤–∏–¥–µ–æ –Ω–∞ YouTube.`); // –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       console.log(`Playing YouTube video: ${embedUrl}`);
     }

     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ –Ω–∞ YouTube (–¥–æ–±–∞–≤–ª–µ–Ω–∞)
     function stopVideo() {
         if (videoArea.classList.contains('active')) {
             console.log('Stopping YouTube video...');
             // –ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ –≤ iframe, –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –µ–≥–æ src –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API
             videoIframe.src = ''; // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - —Å–±—Ä–æ—Å–∏—Ç—å src
             videoArea.classList.remove('active');
             addMessage('–û—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ –≤–∏–¥–µ–æ.');
             console.log('YouTube video stopped.');
         } else {
             addMessage('–í–∏–¥–µ–æ –Ω–∞ YouTube —Å–µ–π—á–∞—Å –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.');
         }
     }
 
     // –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥
     async function sendMessage() {
       const text = userInput.value.trim();
       if (!text || processingMessage) { // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞
          if (processingMessage) addMessage('–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å.', false, true);
          return;
       }
       stopSpeech(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
       processingMessage = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏

       // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
       addMessage(text, true);
       chatHistory.push({ role: 'user', content: text });
       userInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ä–∞–∑—É

       try {
         showThinking();
         await processCommand(text);
       } catch (error) {
         console.error('Send Message Error Catch:', error);
         hideThinking();
         addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.', false, true);
       } finally {
         // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –∫–æ–Ω—Ü–µ
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º processingMessage, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
          // –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –∏–∑ onresult
          setTimeout(() => { processingMessage = false; }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑ onresult
       }
     }
 
     async function processCommand(text) {
       const lowerText = text.toLowerCase();

       // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∫–æ–º–∞–Ω–¥ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã)
       const photoTriggers = ['—Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ','—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π','—Å–¥–µ–ª–∞–π —Å–Ω–∏–º–æ–∫','—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π'];
       const cameraOnTriggers = ['–∫–∞–º–µ—Ä–∞','–≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É','–ø–æ–∫–∞–∂–∏ –∫–∞–º–µ—Ä—É'];
       const cameraOffTriggers = ['—Å—Ç–æ–ø –∫–∞–º–µ—Ä–∞','–≤—ã–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É','—Å–∫—Ä–æ–π –∫–∞–º–µ—Ä—É','—É–±–µ—Ä–∏ –∫–∞–º–µ—Ä—É'];

       // –§—É–Ω–∫—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –ø—Ä–∏–º–µ—Ä.
       const videoStartTriggers = ['–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ','–∑–∞–ø–∏—à–∏ –≤–∏–¥–µ–æ','–Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ'];
       const videoStopTriggers = ['—Å—Ç–æ–ø –≤–∏–¥–µ–æ','–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ –∑–∞–ø–∏—Å—å'];

       const downloadPhotoTriggers = ['—Å–∫–∞—á–∞–π —Ñ–æ—Ç–æ','download photo','–∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ','—Å–æ—Ö—Ä–∞–Ω–∏ —Ñ–æ—Ç–æ'];
       const downloadVideoTriggers = ['—Å–∫–∞—á–∞–π –≤–∏–¥–µ–æ','download video','–∑–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ','—Å–æ—Ö—Ä–∞–Ω–∏ –≤–∏–¥–µ–æ –∑–∞–ø–∏—Å—å'];

       const playYouTubeTriggers  = ['–ø–æ–∫–∞–∂–∏ –≤–∏–¥–µ–æ', '–Ω–∞–π–¥–∏ –≤–∏–¥–µ–æ', '–≤–∫–ª—é—á–∏ –≤–∏–¥–µ–æ', '–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–∏ –≤–∏–¥–µ–æ', '—é—Ç—É–± –≤–∏–¥–µ–æ', '—Å–º–æ—Ç—Ä–µ—Ç—å']; // –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è YouTube
       const stopYouTubeTriggers  = ['—Å—Ç–æ–ø –≤–∏–¥–µ–æ', '–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤–∏–¥–µ–æ', '—Ö–≤–∞—Ç–∏—Ç –≤–∏–¥–µ–æ', '–∑–∞–∫–æ–Ω—á–∏ –≤–∏–¥–µ–æ']; // –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ YouTube
       const replayVideoTriggers  = ['–ø–æ–≤—Ç–æ—Ä–∏ –≤–∏–¥–µ–æ','—Å–Ω–æ–≤–∞ –≤–∏–¥–µ–æ','–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –≤–∏–¥–µ–æ']; // –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–¥–µ–æ

       // –ö–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ–≥–æ (–¥–ª—è –≥–æ–ª–æ—Å–∞ –∏ —Ç–µ–∫—Å—Ç–∞)
       const stopAllCommands = ['—Ö–≤–∞—Ç–∏—Ç','–ø—Ä–µ–∫—Ä–∞—Ç–∏ –≤—Å—ë','–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å—ë', '—Å—Ç–æ–ø –≤—Å–µ', '—Å—Ç–æ–ø'];
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ, —É—á–∏—Ç—ã–≤–∞—è –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤ –∏–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if (stopAllCommands.some(cmd => lowerText === cmd || lowerText.startsWith(cmd + ' ') || lowerText.endsWith(' ' + cmd) || lowerText.includes(' ' + cmd + ' '))) { 
           console.log("Command 'stop' detected.");
           hideThinking();
           stopSpeech(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å
           stopCamera(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
           stopVideo(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
           if (recognition && recognition.recognizing) { // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ
              recognition.stop();
           }
           addMessage('–í—ã–ø–æ–ª–Ω–∏–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É.'); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ —ç—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –º—ã –Ω–µ —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã –¥–∞–ª–µ–µ –∫–æ–¥ —à–µ–ª –≤ AI
            // –ü–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å return.
             processingMessage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
             return;
       }


       // ----- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ -----

       // 1) –§–æ—Ç–æ / –∫–∞–º–µ—Ä–∞
       // –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —á–∞—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º processingMessage –≤—Ä—É—á–Ω—É—é
       if (photoTriggers.some(t => lowerText.includes(t))) {
         hideThinking(); // –°–∫—Ä—ã–≤–∞–µ–º "–î—É–º–∞—é..." –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–º–∞–Ω–¥
         // capturePhoto —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫–∞–º–µ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç
         capturePhoto(); 
         processingMessage = false; // –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±—ã—Å—Ç—Ä–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
         return; 
       } else if (cameraOnTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         await startCamera();
         processingMessage = false;
         return;
       } else if (cameraOffTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         stopCamera();
         processingMessage = false;
         return;
       }

       // 2) –í–∏–¥–µ–æ (–∑–∞–ø–∏—Å—å) - –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ç.–∫. —Ñ—É–Ω–∫—Ü–∏–∏ start/stopRecording –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ UI
       /*
       if (videoStartTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         if (!isCameraActive) await startCamera();
         startRecording();
         processingMessage = false;
         return;
       } else if (videoStopTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         stopRecording();
         processingMessage = false;
         return;
       }
       */

       // 3) –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ / –≤–∏–¥–µ–æ
       // –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —á–∞—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º processingMessage –≤—Ä—É—á–Ω—É—é
       if (downloadPhotoTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         if (!lastPhotoDataUrl) {
           addMessage('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.', false, true);
         } else {
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ, —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ
            const downloadButtons = chatContainer.querySelectorAll('.message button');
            // –ò—â–µ–º —Å –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∞–º–æ–≥–æ —Å–≤–µ–∂–µ–≥–æ —Ñ–æ—Ç–æ
            const lastPhotoDownloadBtn = Array.from(downloadButtons).reverse().find(btn => btn.textContent.includes('–°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ')); 

            if (lastPhotoDownloadBtn) {
                 console.log("Clicking download button for photo.");
                 lastPhotoDownloadBtn.click(); // –ö–ª–∏–∫–∞–µ–º –ø–æ –Ω–µ–π
                 addMessage('–°–∫–∞—á–∏–≤–∞—é —Ñ–æ—Ç–æ...'); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            } else {
                 // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏), —Å–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞–ø—Ä—è–º—É—é
                 console.warn("Download photo button not found in chat, creating link directly.");
                 const a = document.createElement('a');
                 a.href = lastPhotoDataUrl;
                 a.download = 'kiko_photo.jpg'; // –ò–º—è —Ñ–∞–π–ª–∞
                 document.body.appendChild(a); // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ DOM –¥–ª—è Firefox
                 a.click();
                 document.body.removeChild(a); // –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
                 addMessage('–°–∫–∞—á–∏–≤–∞—é —Ñ–æ—Ç–æ...'); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            }
         }
         processingMessage = false;
         return;
       }
        // –ö–æ–º–∞–Ω–¥–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, —Ç.–∫. —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞)
       /*
       else if (downloadVideoTriggers.some(t => lowerText.includes(t))) {
         hideThinking();
         if (!lastVideoBlobUrl) {
           addMessage('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', false, true);
         } else {
             const a = document.createElement('a');
             a.href = lastVideoBlobUrl;
             a.download = 'kiko_video.mp4';
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             addMessage('–°–∫–∞—á–∏–≤–∞—é –≤–∏–¥–µ–æ...'); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
         }
         processingMessage = false;
         return;
       }
       */

       // 4) –ö–æ–º–∞–Ω–¥—ã YouTube

       // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ
       if (stopYouTubeTriggers.some(t => lowerText.includes(t))) {
           hideThinking();
           stopVideo(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ
           processingMessage = false;
           return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥—ã
       }

       // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ
       if (replayVideoTriggers.some(t => lowerText.includes(t))) {
           hideThinking();
           if (lastYouTubeUrl) {
               console.log("Replaying last YouTube video:", lastYouTubeUrl);
               playVideo(lastYouTubeUrl);
           } else {
               addMessage('–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –≤–∏–¥–µ–æ.', false);
           }
           processingMessage = false;
           return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥—ã
       }

       // –ü–æ–∏—Å–∫ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ YouTube –≤–∏–¥–µ–æ
       // –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ AI, —á—Ç–æ–±—ã —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å,
       // –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–æ–º –≤–∏–¥–µ–æ.
       // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–∞–µ—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Ç—Ä–∏–≥–≥–µ—Ä –ø–æ–∏—Å–∫–∞ –≤–∏–¥–µ–æ
       const isYouTubeSearchCommand = playYouTubeTriggers.some(t => lowerText.includes(t));

       if (isYouTubeSearchCommand) {
           hideThinking();
           // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ —Ñ—Ä–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
           let query = text;
           let foundTrigger = false;
           for (const trigger of playYouTubeTriggers) {
               const index = lowerText.indexOf(trigger);
               if (index !== -1) {
                   // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å
                   query = text.substring(index + trigger.length).trim();
                   foundTrigger = true;
                   break; // –ù–∞—à–ª–∏ –ø–µ—Ä–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä, –±–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –Ω–µ–≥–æ
               }
           }

           if (query) { // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å
               addMessage(`–ò—â—É –≤–∏–¥–µ–æ –Ω–∞ YouTube –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"...`);
               showThinking(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∫–∞ –∏—â–µ–º
               const foundVideoUrl = await searchYouTube(query);
               hideThinking(); // –°–∫—Ä—ã–≤–∞–µ–º "–î—É–º–∞—é..." –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞
               if (foundVideoUrl) {
                   playVideo(foundVideoUrl);
                   // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –ø–æ—Å–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ, —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É..."
               } else {
                   // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
                   addMessage(`–ù–µ —Å–º–æ–≥–ª–∞ –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ –Ω–∞ YouTube –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É.`);
                   // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ AI, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                   // const aiResponse = await getGeminiResponse(`–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∏–¥–µ–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}". –î–∞–π —Å–æ–≤–µ—Ç –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ.`);
                   // addMessage(aiResponse);
                   // chatHistory.push({ role: 'assistant', content: aiResponse });
               }
           } else { // –ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞
               addMessage('–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–∞–π—Ç–∏ –Ω–∞ YouTube? ü§î', false);
           }
           processingMessage = false; // –í–∞–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã YouTube
           return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥—ã YouTube
       }


       // ----- –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI (Gemini) -----

       // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è/–ø—Ä–æ—Å—Ç—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –∏–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ AI, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
       const skipAI = ["–∫–∞–∫ –¥–µ–ª–∞", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫–∞–∫ —Ç—ã", "—á—Ç–æ –Ω–æ–≤–æ–≥–æ", "–ø—Ä–∏–≤–µ—Ç", "–∫–∞–∫ –∂–∏–∑–Ω—å", "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è", "—Å–ø–∞—Å–∏–±–æ", "–æ–∫", "—Ö–æ—Ä–æ—à–æ", "–¥–∞", "–Ω–µ—Ç", "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞"];
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —Ñ—Ä–∞–∑—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è/–∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â—É—é—Å—è –Ω–∞ —ç—Ç–∏ —Å–ª–æ–≤–∞
        if (skipAI.some(trigger => lowerText === trigger || lowerText.startsWith(trigger + ' ') || lowerText.endsWith(' ' + trigger) || lowerText.includes(' ' + trigger + ' '))) {
            // –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞, –æ—Ç–≤–µ—á–∞–µ–º –ø—Ä–æ—Å—Ç–æ
            let simpleResponse = "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"; // –ü—Ä–æ—Å—Ç–æ–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (lowerText.includes('—Å–ø–∞—Å–∏–±–æ')) simpleResponse = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥–∞ –ø–æ–º–æ—á—å! üòä";
            else if (lowerText.includes('–ø—Ä–∏–≤–µ—Ç')) simpleResponse = "–ü—Ä–∏–≤–µ—Ç! üëã";
            else if (lowerText.includes('–∫–∞–∫ –¥–µ–ª–∞')) simpleResponse = "–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ê —É —Ç–µ–±—è –∫–∞–∫? üòä";
             else if (lowerText === '–æ–∫' || lowerText === '—Ö–æ—Ä–æ—à–æ' || lowerText === '–¥–∞') simpleResponse = "üëç";
              else if (lowerText === '–Ω–µ—Ç') simpleResponse = "–•–æ—Ä–æ—à–æ!";
              else if (lowerText.includes('–ø–æ–∂–∞–ª—É–π—Å—Ç–∞')) simpleResponse = "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! üòâ";


            hideThinking();
            addMessage(simpleResponse);
            // –ü—Ä–æ—Å—Ç—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç AI.
            processingMessage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        }


       // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Gemini
       console.log("Sending query to Gemini:", text);
       // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ sendMessage)
       // chatHistory.push({ role: 'user', content: text }); // –≠—Ç–æ —É–∂–µ –≤ sendMessage

       // –í—ã–∑—ã–≤–∞–µ–º getGeminiResponse, —Ç.–∫. –Ω—É–∂–µ–Ω Gemini
       const aiResponse = await getGeminiResponse(text); 
       hideThinking(); // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –æ—Ç–≤–µ—Ç–∞
       addMessage(aiResponse); // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ —á–∞—Ç
       // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
       chatHistory.push({ role: 'assistant', content: aiResponse });

       // processingMessage = false; // –§–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ finally –≤ sendMessage –∏–ª–∏ –≤ onresult (–¥–ª—è –≥–æ–ª–æ—Å–∞)
     }
 
     // –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏)
     function setupSpeechRecognition() {
       // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
       if (!('webkitSpeechRecognition' in window)) {
         addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.', false, true);
         if (voiceBtn) voiceBtn.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
         console.error("webkitSpeechRecognition not supported.");
         return null;
       }
 
       const recognitionObj = new webkitSpeechRecognition();
       recognitionObj.continuous = true; // –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (—Å–ª—É—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
       recognitionObj.interimResults = true; // –ü–æ–ª—É—á–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–¥–ª—è –ª—É—á—à–µ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏ –∏ –∫–æ–º–∞–Ω–¥—ã "—Å—Ç–æ–ø")
       recognitionObj.lang = 'ru-RU'; // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫

       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤–Ω—É—Ç—Ä—å setupSpeechRecognition)

       recognitionObj.onstart = () => {
         console.log('Speech recognition started.');
         listeningIndicator.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
         voiceBtn.classList.add('active'); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É (–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å)
         // addMessage('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ.'); // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –ª—É—á—à–µ –±–µ–∑ —ç—Ç–æ–≥–æ
       };

       recognitionObj.onresult = async (event) => {
         // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≥–æ–ª–æ—Å–æ–≤–æ–º –≤–≤–æ–¥–µ
         activateSpeechSynthesis();

         // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
         const result = event.results[event.results.length - 1];
         // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º)
         let text = result[0].transcript.trim();
         let lowerText = text.toLowerCase();

         // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "—Å—Ç–æ–ø" –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∞–∂–µ –Ω–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
         const stopAllCommands = ['—Ö–≤–∞—Ç–∏—Ç','–ø—Ä–µ–∫—Ä–∞—Ç–∏ –≤—Å—ë','–æ—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å—ë', '—Å—Ç–æ–ø –≤—Å–µ', '—Å—Ç–æ–ø'];
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–∞–µ—Ç –ª–∏ —Ç–µ–∫—Å—Ç (–¥–∞–∂–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π) –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
         if (stopAllCommands.some(cmd => lowerText.includes(cmd))) {
             console.log("Voice command 'stop' detected (interim or final).");
             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–æ –ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
             if (recognitionObj && recognitionObj.recognizing) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º recognizing
                recognitionObj.stop(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (–≤—ã–∑–æ–≤–µ—Ç onend)
             }
             // stopSpeech, stopCamera, stopVideo –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ processCommand,
             // –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞, –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ "—Å—Ç–æ–ø"
             // —Å–∫–∞–∑–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–∞–∑—ã.
             stopSpeech();
             stopCamera();
             stopVideo();

             // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –∫–ª–∞—Å—Å –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã –≤ onend
             // addMessage('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–µ.'); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ
             processingMessage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
             if (noSpeechTimer) clearTimeout(noSpeechTimer); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
             lastRecognizedText = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è –Ω–æ–≤–æ–π —Ñ—Ä–∞–∑—ã
             return; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
         }


         // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –§–ò–ù–ê–õ–¨–ù–´–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
         if (result.isFinal) {
             console.log("Final voice result:", text);
              // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω –¥–æ –µ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
             if (noSpeechTimer) clearTimeout(noSpeechTimer);

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–∏ –º—ã —É–∂–µ —á—Ç–æ-—Ç–æ –ò –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞
              // (–õ–æ–≥–∏–∫–∞ —Å lastRecognizedText –∏ noSpeechTimer –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞,
              // —Ç.–∫. –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ –µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π)
             if (text.length > 0 && text.toLowerCase() !== lastRecognizedText && !processingMessage) {
                lastRecognizedText = text.toLowerCase(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é —Ñ—Ä–∞–∑—É
                processingMessage = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏

                 // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
                addMessage(text, true);
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–ª—è AI)
                chatHistory.push({ role: 'user', content: text });
                showThinking(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

                try {
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É/–∑–∞–ø—Ä–æ—Å –∫ AI
                    // processCommand –æ–∂–∏–¥–∞–µ—Ç lowerText, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
                    await processCommand(text); 

                } catch (error) {
                    console.error('Error processing final voice message:', error);
                    hideThinking();
                    addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.', false, true);
                } finally {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º processingMessage, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    // –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞.
                    setTimeout(() => {
                         processingMessage = false;
                         // lastRecognizedText = ''; // –ú–æ–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å lastRecognizedText –∑–¥–µ—Å—å
                    }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
                }
             } else {
                  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –∏–ª–∏ –æ–Ω –¥—É–±–ª–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π.
                  console.log("Ignoring final voice result (processing active, text empty, or duplicate):", text);
             }
         } else {
             // –≠—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –õ–æ–≥–∏–∫–∞ noSpeechTimer –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.
             // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–µ—á–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥.
              if (noSpeechTimer) clearTimeout(noSpeechTimer);
              noSpeechTimer = setTimeout(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç, –Ω–µ –∏–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞, –∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ
                if (text && text.toLowerCase() !== lastRecognizedText && !processingMessage) {
                  console.log("Processing interim voice result after delay:", text);
                  lastRecognizedText = text.toLowerCase(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é —Ñ—Ä–∞–∑—É
                  processingMessage = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                  addMessage(text, true); // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                  showThinking(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É/–∑–∞–ø—Ä–æ—Å –∫ AI
                  processCommand(text) // –í—ã–∑—ã–≤–∞–µ–º processCommand —Å —Ç–µ–∫—Å—Ç–æ–º (–ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
                  .finally(() => {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    setTimeout(() => {
                      processingMessage = false;
                      // lastRecognizedText = ''; // –ú–æ–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å lastRecognizedText –∑–¥–µ—Å—å
                    }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
                  });
                }
              }, 2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
         }
       };

       recognitionObj.onerror = (event) => {
         console.error('Speech recognition error:', event.error);
         hideThinking(); // –°–∫—Ä—ã–≤–∞–µ–º "–î—É–º–∞—é..."
         processingMessage = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
         if (noSpeechTimer) clearTimeout(noSpeechTimer); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
         lastRecognizedText = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º

         let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —Ä–µ—á–∏.';

         // –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
         if (event.error === 'audio-capture') {
           errorMessage = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.';
         } else if (event.error === 'not-allowed') {
           errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.';
           // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –≤–µ—Ä–æ—è—Ç–Ω–æ, —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.
           // –ö–Ω–æ–ø–∫–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–æ–ª–∂–Ω—ã —Å–±—Ä–æ—Å–∏—Ç—å—Å—è –≤ onend, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å –∑–¥–µ—Å—å –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π.
           listeningIndicator.style.display = 'none';
           voiceBtn.classList.remove('active');
           // –í–∞–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å recognition –≤ null –ø—Ä–∏ —ç—Ç–æ–π –æ—à–∏–±–∫–µ
           if (recognition === recognitionObj) recognition = null;
         } else if (event.error === 'no-speech') {
             // –û—à–∏–±–∫–∞ "–Ω–∏—á–µ–≥–æ –Ω–µ —É—Å–ª—ã—à–∞–Ω–æ". –ï—Å–ª–∏ continuous=true, –¥–≤–∏–∂–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–ª—É—à–∞—Ç—å.
             // addMessage('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ —Ä–µ—á—å. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.'); // –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ª—É—á—à–µ –±–µ–∑ –Ω–µ–≥–æ
             console.log('Speech recognition error: No speech detected.');
             // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ (timeout –Ω–∏–∂–µ)
             // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –¥–ª—è —ç—Ç–æ–π –æ—à–∏–±–∫–∏
             return; // –í—ã—Ö–æ–¥–∏–º, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—è recognition –¥–ª—è no-speech
         } else if (event.error === 'network') {
              errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —Ä–µ—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
         } else if (event.error === 'aborted') {
             // –û—à–∏–±–∫–∞ 'aborted' –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ recognition.stop(). –≠—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∞—è –æ—à–∏–±–∫–∞.
             console.log('Speech recognition aborted (stopped intentionally).');
             // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º recognition –≤ null –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
             return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É "–æ—à–∏–±–∫—É"
         } else {
             errorMessage += `: ${event.error}`; // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞
         }

         // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ —á–∞—Ç (–∫—Ä–æ–º–µ no-speech –∏ aborted)
         addMessage(errorMessage, false, true);
         // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –∫–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—à–µ–Ω—ã –ø—Ä–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –Ω–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç–∞
         // or if restart fails quickly. This is also handled in onend, but good fallback.
         // if (event.error !== 'no-speech' && event.error !== 'aborted' && (event.error === 'not-allowed' || event.error === 'network')) {
              // listeningIndicator.style.display = 'none';
              // voiceBtn.classList.remove('active');
         // }

         // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ (–ª–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
         // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 'no-speech', 'audio-capture' –∏–ª–∏ –¥—Ä—É–≥–∞—è, –∫—Ä–æ–º–µ not-allowed/aborted/network
         // Note: Logic in provided code restarts on 'no-speech', let's follow that.
         if (event.error === 'no-speech' || event.error === 'audio-capture' || (event.error !== 'not-allowed' && event.error !== 'aborted' && event.error !== 'network')) {
              console.log("Attempting to restart recognition after error...");
              setTimeout(() => {
                 // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ recognition –≤—Å–µ –µ—â–µ null –∏–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞—à –æ–±—ä–µ–∫—Ç
                 if (!recognition || recognition === recognitionObj) {
                      try {
                         // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π null (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ not-allowed)
                         if (!recognition) recognition = setupSpeechRecognition();
                         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å—Ç–∞—Ä—Ç–∞/—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                         if (recognition && !recognition.recognizing && recognition.state !== 'starting') {
                              recognition.start();
                         } else {
                             console.warn('Skipping restart after error: recognition object invalid or already active.');
                         }
                      } catch(e) {
                         console.error("Failed to restart recognition after error:", e);
                         addMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏.", false, true);
                      }
                 } else {
                     console.log('Skipping restart after error: recognition object has changed.');
                 }
              }, event.error === 'no-speech' ? 300 : 1000); // 300ms –¥–ª—è no-speech, 1000ms –¥–ª—è –¥—Ä—É–≥–∏—Ö
         } else {
            // –î–ª—è 'not-allowed' –∏ 'network' –æ—à–∏–±–æ–∫, –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
             console.log('Skipping auto-restart for error:', event.error);
         }
       };

       recognitionObj.onend = () => {
         console.log('Speech recognition ended.');
         listeningIndicator.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
         voiceBtn.classList.remove('active'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏

         // –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞,
         // —Ö–æ—Ç—è –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ recognition –≤—Å–µ –µ—â–µ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–∞—à –æ–±—ä–µ–∫—Ç
         if (recognition === recognitionObj) {
           setTimeout(() => {
             // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ—Ä–æ—Ç–∫–æ–π –ø–∞—É–∑—ã, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –Ω–µ –Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
             // –∏ –Ω–µ –∏–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ñ—Ä–∞–∑—ã
             if (recognition === recognitionObj && !processingMessage) {
               try {
                 console.log('Attempting to restart speech recognition automatically (onend)...');
                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ recognition –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å—Ç–∞—Ä—Ç–∞/—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                 if (!recognitionObj.recognizing && recognitionObj.state !== 'starting') {
                     recognitionObj.start();
                 } else {
                    console.log('Skipping restart from onend: recognition already active or starting.');
                 }
               } catch (error) {
                 console.error('Failed to restart recognition automatically from onend:', error);
                 // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                 // addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.', false, true);
               }
             } else {
                  console.log('Auto-restart skipped from onend: processing active or recognition object changed.');
             }
           }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ (–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è)
         } else {
             console.log('Recognition object changed, skipping auto-restart from onend.');
         }
       };
       
       return recognitionObj; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
     }
 
     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤–∫–ª/–≤—ã–∫–ª)
     function toggleVoiceInput() {
       // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º recognition —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω
       if (!recognition) {
         console.log('Speech recognition object is null, attempting setup...');
         recognition = setupSpeechRecognition();
         // –ï—Å–ª–∏ setupSpeechRecognition –≤–µ—Ä–Ω—É–ª null (–±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç), –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
         if (!recognition) {
             console.warn("Speech recognition setup failed.");
             return;
         }
       }

       // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ recognition —Å –ø–æ–º–æ—â—å—é recognizing
       // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: recognition.isRecognitionActive –∏ voiceBtn.classList.contains('active') –Ω–∞ recognition.recognizing
       if (recognition.recognizing) { // –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
         console.log('Stopping speech recognition via button...');
         recognition.stop(); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç onend
       } else { // –ï—Å–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ–º
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–∏–Ω—Ç–µ–∑ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
          stopSpeech();
          console.log('Starting speech recognition via button...');
         try {
            recognition.start(); // –ó–∞–ø—É—Å–∫–∞–µ–º (—ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç onstart)
         } catch (e) {
            console.error('Error starting speech recognition via button:', e);
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —Å—Ç–∞—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –Ω–æ state –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)
            // –ë—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ recognition.start() –≤—ã–∑–≤–∞–Ω, –∫–æ–≥–¥–∞ –æ–Ω–æ —É–∂–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ starting –∏–ª–∏ recognizing
            addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–æ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ.', false, true);
         }
       }
     }
 
     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø—É–ª—å—Ç–∞ –¥–ª—è Android TV –∏ Escape
     document.addEventListener('keydown', (e) => {
       // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ª—é–±–æ–π –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
       activateSpeechSynthesis();

       switch(e.keyCode) {
         case 13: // OK / Enter
           e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
           // –õ–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:
           // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
           // –ò–Ω–∞—á–µ, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
           if (document.activeElement === userInput) {
             sendMessage();
           } else {
             toggleVoiceInput();
           }
           break;
         case 37: // Left
           // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–æ–∫—É—Å (–ª–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
            if (document.activeElement === voiceBtn) {
               userInput.focus();
               e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–∫—Ä–æ–ª–ª
            } else if (document.activeElement === cameraBtn) {
                // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–æ–∫—É—Å –∫—É–¥–∞-—Ç–æ –µ—â–µ? (–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º –∫–æ–¥–µ —ç—Ç–æ–≥–æ –Ω–µ—Ç)
            }
           break;
         case 39: // Right
           // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–æ–∫—É—Å (–ª–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
            if (document.activeElement === userInput) {
                voiceBtn.focus();
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–∫—Ä–æ–ª–ª
            } else if (document.activeElement === cameraBtn) {
                // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–æ–∫—É—Å –∫—É–¥–∞-—Ç–æ –µ—â–µ?
            }
           break;
         case 27: // Back / Escape
           // –õ–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
           console.log("Escape key pressed. Stopping everything.");
           stopSpeech();
           stopCamera();
           stopRecording(); // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –∞–∫—Ç–∏–≤–Ω–∞
           if (recognition && recognition.recognizing) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º recognizing
             recognition.stop();
           }
            // addMessage('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Escape.'); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ
            processingMessage = false; // –í–∞–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (noSpeechTimer) clearTimeout(noSpeechTimer); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
            lastRecognizedText = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º
           break;
         // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –∫–µ–π—Å—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –¢–í
         // case 38: // Up
         // case 40: // Down
       }
     });
 
     // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ initApp –∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ DOMContentLoaded
     function initApp() {
        console.log('DOM fully loaded. Initializing application.');

       // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Android TV
       if (isAndroidTV) {
         initForTV();
       }
        // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è voiceschanged
       if ('speechSynthesis' in window) {
         // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤ –∑–∞—Ä–∞–Ω–µ–µ (–Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
         window.speechSynthesis.onvoiceschanged = () => {
            console.log("Speech synthesis voices changed/loaded.");
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ getVoices –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å
            window.speechSynthesis.getVoices();
         };
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –í Chrome —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.
          window.speechSynthesis.getVoices();
       } else {
           console.warn("Speech synthesis not supported in this browser.");
       }

       // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
       addMessage('üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ö–∏–∫–æ, —Ç–≤–æ–π —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º —è –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?');

       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–Ω–æ–ø–æ–∫ –∏ –≤–≤–æ–¥–∞
       if (sendBtn) {
           // –£–±—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤ sendMessage
           sendBtn.addEventListener('click', sendMessage);
            // –î–æ–±–∞–≤–ª—è–µ–º tabindex –¥–ª—è TV –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ TV
            if (isAndroidTV) sendBtn.setAttribute('tabindex', '0');
       } else { console.error("Send button element not found!"); }

       if (userInput) {
           userInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
               e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
               // –£–±—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤ sendMessage
               sendMessage();
             }
           });
           // –î–æ–±–∞–≤–ª—è–µ–º tabindex –¥–ª—è TV –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ TV
           if (isAndroidTV) userInput.setAttribute('tabindex', '0');
       } else { console.error("User input element not found!"); }

       if (voiceBtn) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            // –£–±—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –∑–¥–µ—Å—å, —Ç.–∫. –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤ onresult –∏–ª–∏ toggleVoiceInput
           voiceBtn.addEventListener('click', toggleVoiceInput);
            // –î–æ–±–∞–≤–ª—è–µ–º tabindex –¥–ª—è TV –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ TV
            if (isAndroidTV) voiceBtn.setAttribute('tabindex', '0');
       } else { console.error("Voice button element not found!"); }

       if (cameraBtn) {
            cameraBtn.addEventListener('click', capturePhoto); // capturePhoto —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–º–µ—Ä—É
            // –î–æ–±–∞–≤–ª—è–µ–º tabindex –¥–ª—è TV –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ TV
            if (isAndroidTV) cameraBtn.setAttribute('tabindex', '0');
        } else { console.error("Camera button element not found!"); }


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è recognition –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
        // –ó–∞–ø—É—Å–∫ –±—É–¥–µ—Ç –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –∏–ª–∏ —á–µ—Ä–µ–∑ TV –ø—É–ª—å—Ç (–µ—Å–ª–∏ –≤ toggleVoiceInput)
        // recognition = setupSpeechRecognition(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ toggleVoiceInput –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–≤–æ–º—É –∫–ª–∏–∫—É

       // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏ —Ñ–æ–∫—É—Å–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–æ–±–∞–≤–ª–µ–Ω–æ)
       document.addEventListener('visibilitychange', () => {
         if (document.hidden) {
           console.log("Page is hidden. Stopping speech and recognition.");
           // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ—á–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
           stopSpeech();
           if (recognition && recognition.recognizing) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º recognizing
             recognition.stop();
           }
           // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏–ª–∏ –≤–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏, —Ç–æ–ª—å–∫–æ —Ä–µ—á—å/—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
         } else {
            console.log("Page is visible.");
            // –í–æ–∑–º–æ–∂–Ω–æ, —Ç—É—Ç —Å—Ç–æ–∏—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ –¥–æ —Å–∫—Ä—ã—Ç–∏—è?
            // –ù–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫.
         }
       });

       // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ iframe YouTube (–¥–æ–±–∞–≤–ª–µ–Ω–æ)
        if (videoIframe) {
             videoIframe.onerror = () => {
               console.error('YouTube iframe loading error');
               addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ', false, true);
               stopVideo(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
             };
        } else {
            console.error("YouTube iframe element not found!");
        }

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
        // –≠—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É speak().
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º addEventListener –±–µ–∑ once, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ —É–¥–∞–ª–∏—Ç—å
        document.body.addEventListener('click', activateSpeechSynthesis, { once: true });
        document.body.addEventListener('keydown', activateSpeechSynthesis, { once: true });
        document.body.addEventListener('touchstart', activateSpeechSynthesis, { once: true }); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        document.body.addEventListener('focus', activateSpeechSynthesis, { once: true }); // –î–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤

        console.log('App initialization complete. Event listeners attached.');
     }
 
     // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
     // –ò–∑–º–µ–Ω–µ–Ω–æ —Å window.load –Ω–∞ DOMContentLoaded –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     document.addEventListener('DOMContentLoaded', initApp);

     // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ speakResponse –∏ initApp)
     // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ initApp, –µ–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
     // function loadVoices() {
     //   let voices = [];
     //   function setVoices() {
     //     voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
     //     if (voices.length > 0) {
     //       const ruVoice = voices.find(voice => voice.lang.startsWith('ru'));
     //       if (ruVoice) {
     //         console.log('–†—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å –Ω–∞–π–¥–µ–Ω:', ruVoice.name);
     //       }
     //     }
     //   }
     //   if (window.speechSynthesis) {
     //     setVoices();
     //     window.speechSynthesis.onvoiceschanged = setVoices;
     //   }
     // }
 
     // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —è–≤–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)
     // –õ–æ–≥–∏–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π speechActivated –∏ –≤—ã–∑–æ–≤–æ–º speak()
     // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ, –∫–∞–∫ —á–∞—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç.
     // function activateSpeechSynthesis() {
     //   if (!speechActivated) {
     //     const utterance = new SpeechSynthesisUtterance(' ');
     //     window.speechSynthesis.speak(utterance);
     //     speechActivated = true;
     //   }
     // }
 
   </script>
 </body>
 </html>
